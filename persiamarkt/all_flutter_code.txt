

====================
فایل: web_plugin_registrant.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\.dart_tool\dartpad\web_plugin_registrant.dart
====================

// Flutter web plugin registrant file.
//
// Generated file. Do not edit.
//

// @dart = 2.13
// ignore_for_file: type=lint

import 'package:geolocator_web/geolocator_web.dart';
import 'package:shared_preferences_web/shared_preferences_web.dart';
import 'package:flutter_web_plugins/flutter_web_plugins.dart';

void registerPlugins([final Registrar? pluginRegistrar]) {
  final Registrar registrar = pluginRegistrar ?? webPluginRegistrar;
  GeolocatorPlugin.registerWith(registrar);
  SharedPreferencesPlugin.registerWith(registrar);
  registrar.registerMessageHandler();
}


====================
فایل: main.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\main.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:persia_markt/core/config/app_router.dart';
import 'package:persia_markt/core/config/service_locator.dart';
import 'package:persia_markt/core/cubit/locale_cubit.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_cubit.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_event.dart';
import 'package:persia_markt/features/home/presentation/cubit/location_cubit.dart';
import 'package:persia_markt/features/profile/presentation/cubit/favorites_cubit.dart';
import 'package:persia_markt/features/search/presentation/cubit/search_cubit.dart';
import 'package:persia_markt/l10n/app_localizations.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await setupServiceLocator();
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MultiBlocProvider(
      providers: [
        BlocProvider(create: (_) => LocaleCubit()),
        BlocProvider(create: (_) => sl<MarketDataBloc>()..add(FetchMarketDataEvent())),
        BlocProvider(create: (_) => sl<LocationCubit>()..fetchLocation()),
        BlocProvider(create: (_) => sl<FavoritesCubit>()..loadLikedProducts()),
        BlocProvider(create: (_) => sl<SearchCubit>()),
        BlocProvider(create: (_) => sl<AuthCubit>()),
      ],
      child: BlocBuilder<LocaleCubit, Locale>(
        builder: (context, locale) {
          return MaterialApp.router(
            onGenerateTitle: (context) => AppLocalizations.of(context)!.persiaMarkt,
            debugShowCheckedModeBanner: false,
            routerConfig: AppRouter.router,
            locale: locale,
            localizationsDelegates: const [
              AppLocalizations.delegate,
              GlobalMaterialLocalizations.delegate,
              GlobalWidgetsLocalizations.delegate,
              GlobalCupertinoLocalizations.delegate,
            ],
            supportedLocales: const [
              Locale('fa'),
              Locale('en'),
              Locale('de'),
            ],
            theme: _buildTheme(Brightness.light),
            darkTheme: _buildTheme(Brightness.dark),
            themeMode: ThemeMode.system,
          );
        },
      ),
    );
  }

  ThemeData _buildTheme(Brightness brightness) {
    final isLight = brightness == Brightness.light;
    final surfaceColor = isLight ? Colors.white : const Color(0xFF1E1E1E);
    final scaffoldColor = isLight ? const Color(0xFFF5F5F5) : const Color(0xFF121212);
    final colorScheme = ColorScheme.fromSeed(
      seedColor: const Color(0xFFF57C00),
      brightness: brightness,
      primary: const Color(0xFFF57C00),
      secondary: const Color(0xFFFF9800),
      surface: surfaceColor,
      onSurface: isLight ? Colors.black87 : Colors.white,
      outline: isLight ? Colors.grey.shade300 : Colors.grey.shade700,
    );
    final baseTheme = ThemeData(
      useMaterial3: true,
      brightness: brightness,
      colorScheme: colorScheme,
    );
    return baseTheme.copyWith(
      scaffoldBackgroundColor: scaffoldColor,
      appBarTheme: AppBarTheme(
        backgroundColor: colorScheme.surface,
        elevation: 0,
        iconTheme: IconThemeData(color: colorScheme.onSurface),
        titleTextStyle: GoogleFonts.lalezar(
          color: colorScheme.onSurface,
          fontSize: 22,
        ),
      ),
      textTheme: GoogleFonts.vazirmatnTextTheme(baseTheme.textTheme).copyWith(
        headlineMedium: GoogleFonts.vazirmatn(
            fontWeight: FontWeight.bold, color: colorScheme.onSurface),
        titleLarge: GoogleFonts.vazirmatn(
            fontWeight: FontWeight.bold, color: colorScheme.onSurface),
        bodyMedium:
            GoogleFonts.vazirmatn(fontSize: 15, color: colorScheme.onSurface),
        labelLarge: GoogleFonts.vazirmatn(fontWeight: FontWeight.bold),
      ).apply(
        bodyColor: colorScheme.onSurface,
        displayColor: colorScheme.onSurface,
      ),
      cardTheme: CardThemeData(
        elevation: 0,
        shape: RoundedRectangleBorder(
          borderRadius: const BorderRadius.all(Radius.circular(16)),
          side: BorderSide(
            color: colorScheme.outline.withAlpha((255 * 0.5).round()),
            width: 1,
          ),
        ),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          elevation: 0.5,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          backgroundColor: colorScheme.primary,
          foregroundColor: colorScheme.onPrimary,
          padding:
              const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: colorScheme.surface,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        hintStyle: TextStyle(color: Colors.grey.shade500),
      ),
      bottomNavigationBarTheme: BottomNavigationBarThemeData(
        backgroundColor: colorScheme.surface,
        selectedItemColor: colorScheme.primary,
        unselectedItemColor: Colors.grey,
        elevation: 5,
      ),
    );
  }
}


====================
فایل: app_router.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\config\app_router.dart
====================

// مسیر: lib/core/config/app_router.dart

import 'dart:async';
import 'package:flutter/material.dart'; // <<< مشکل اصلی اینجا بود و برطرف شد
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/config/service_locator.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_cubit.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_state.dart';
import 'package:persia_markt/features/auth/presentation/view/login_view.dart';
import 'package:persia_markt/features/auth/presentation/view/register_view.dart';
import 'package:persia_markt/features/category/view/category_detail_view.dart';
import 'package:persia_markt/features/home/presentation/view/home_view.dart';
import 'package:persia_markt/features/home/presentation/view/main_tab_bar_view.dart';
import 'package:persia_markt/features/map/view/map_view.dart';
import 'package:persia_markt/features/profile/presentation/view/favorites_view.dart';
import 'package:persia_markt/features/profile/presentation/view/profile_view.dart';
import 'package:persia_markt/features/search/presentation/view/search_view.dart';
import 'package:persia_markt/features/seller_panel/view/seller_panel_view.dart';
import 'package:persia_markt/features/store/presentation/view/store_detail_view.dart';
import 'app_routes.dart';

final _rootNavigatorKey = GlobalKey<NavigatorState>();
final _shellNavigatorHomeKey = GlobalKey<NavigatorState>(debugLabel: 'shellHome');
final _shellNavigatorMapKey = GlobalKey<NavigatorState>(debugLabel: 'shellMap');
final _shellNavigatorFavoritesKey = GlobalKey<NavigatorState>(debugLabel: 'shellFavorites');
final _shellNavigatorProfileKey = GlobalKey<NavigatorState>(debugLabel: 'shellProfile');

class AppRouter {
  static final router = GoRouter(
    initialLocation: AppRoutes.home,
    navigatorKey: _rootNavigatorKey,
    refreshListenable: GoRouterRefreshStream(sl<AuthCubit>().stream),
    redirect: (BuildContext context, GoRouterState state) {
      final authState = context.read<AuthCubit>().state;
      final isLoggedIn = authState is Authenticated;
      
      final authRelatedRoutes = [AppRoutes.login, AppRoutes.register, AppRoutes.sellerPanel];
      final onAuthRoutes = authRelatedRoutes.contains(state.matchedLocation);

      if (!isLoggedIn && !onAuthRoutes) {
        return AppRoutes.login;
      }
      if (isLoggedIn && onAuthRoutes) {
        return AppRoutes.home;
      }
      return null;
    },
    routes: [
      StatefulShellRoute.indexedStack(
        builder: (context, state, navigationShell) {
          return MainTabBarView(navigationShell: navigationShell);
        },
        branches: [
          _buildBranch(
            navigatorKey: _shellNavigatorHomeKey,
            routes: [
              GoRoute(
                path: AppRoutes.home,
                pageBuilder: (context, state) => _buildPageWithTransition(
                  key: state.pageKey,
                  child: const HomeView(),
                ),
                routes: [
                  GoRoute(
                    path: AppRoutes.storeDetail,
                    pageBuilder: (context, state) {
                      final storeId = state.pathParameters['storeId']!;
                      final initialProductId = state.uri.queryParameters['productId'];
                      return _buildPageWithTransition(
                        key: state.pageKey,
                        child: StoreDetailView(
                          storeId: storeId,
                          initialProductId: initialProductId,
                        ),
                      );
                    },
                  ),
                  GoRoute(
                    path: AppRoutes.categoryDetail,
                    pageBuilder: (context, state) {
                      final categoryId = state.pathParameters['categoryId']!;
                      return _buildPageWithTransition(
                        key: state.pageKey,
                        child: CategoryDetailView(categoryId: categoryId),
                      );
                    },
                  ),
                ],
              ),
            ],
          ),
          _buildBranch(
            navigatorKey: _shellNavigatorMapKey,
            routes: [
              GoRoute(
                path: AppRoutes.map,
                pageBuilder: (context, state) {
                  final lat = state.uri.queryParameters['lat'];
                  final lng = state.uri.queryParameters['lng'];
                  final focus = state.uri.queryParameters['focus'];
                  return _buildPageWithTransition(
                    key: state.pageKey,
                    child: MapView(lat: lat, lng: lng, focus: focus),
                  );
                },
              ),
            ],
          ),
          _buildBranch(
            navigatorKey: _shellNavigatorFavoritesKey,
            routes: [
              GoRoute(
                path: AppRoutes.favorites,
                pageBuilder: (context, state) => _buildPageWithTransition(
                  key: state.pageKey,
                  child: const FavoritesView(),
                ),
              ),
            ],
          ),
          _buildBranch(
            navigatorKey: _shellNavigatorProfileKey,
            routes: [
              GoRoute(
                path: AppRoutes.profile,
                pageBuilder: (context, state) => _buildPageWithTransition(
                  key: state.pageKey,
                  child: const ProfileView(),
                ),
              ),
            ],
          ),
        ],
      ),
      GoRoute(
        path: AppRoutes.search,
        parentNavigatorKey: _rootNavigatorKey,
        pageBuilder: (context, state) => _buildPageWithTransition(
          key: state.pageKey,
          child: const SearchView(),
        ),
      ),
      GoRoute(
        path: AppRoutes.login,
        parentNavigatorKey: _rootNavigatorKey,
        pageBuilder: (context, state) => _buildPageWithTransition(
          key: state.pageKey,
          child: const LoginView(),
        ),
      ),
      GoRoute(
        path: AppRoutes.register,
        parentNavigatorKey: _rootNavigatorKey,
        pageBuilder: (context, state) => _buildPageWithTransition(
          key: state.pageKey,
          child: const RegisterView(),
        ),
      ),
      GoRoute(
        path: AppRoutes.sellerPanel,
        parentNavigatorKey: _rootNavigatorKey,
        pageBuilder: (context, state) => const MaterialPage(
          fullscreenDialog: true,
          child: SellerPanelView(),
        ),
      ),
    ],
  );

  static StatefulShellBranch _buildBranch({
    required GlobalKey<NavigatorState> navigatorKey,
    required List<RouteBase> routes,
  }) {
    return StatefulShellBranch(
      navigatorKey: navigatorKey,
      routes: routes,
    );
  }

  static CustomTransitionPage _buildPageWithTransition<T>({
    required LocalKey key,
    required Widget child,
  }) {
    return CustomTransitionPage<T>(
      key: key,
      child: child,
      transitionsBuilder: (context, animation, secondaryAnimation, child) {
        return FadeTransition(opacity: animation, child: child);
      },
    );
  }
}

class GoRouterRefreshStream extends ChangeNotifier {
  GoRouterRefreshStream(Stream<dynamic> stream) {
    notifyListeners();
    _subscription = stream.asBroadcastStream().listen((_) => notifyListeners());
  }
  late final StreamSubscription<dynamic> _subscription;
  @override
  void dispose() {
    _subscription.cancel();
    super.dispose();
  }
}

====================
فایل: app_routes.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\config\app_routes.dart
====================

// مسیر: lib/core/config/app_routes.dart

class AppRoutes {
  // مسیرهای اصلی Shell
  static const String home = '/';
  static const String map = '/map';
  static const String favorites = '/favorites';
  static const String profile = '/profile';

  // مسیرهای خارج از Shell اصلی (صفحات کامل)
  static const String search = '/search';
  static const String login = '/login';
  static const String register = '/register';
  static const String sellerPanel = '/seller-panel'; // <<< این خط جدید اضافه شده است

  // مسیرهای داینامیک (فرزندان مسیر خانه)
  static const String storeDetail = 'store/:storeId';
  static const String categoryDetail = 'category/:categoryId';

  // متدهای کمکی برای ساخت مسیرهای پیچیده به صورت امن و خوانا
  static String storeDetailPath(String storeId, {String? productId}) {
    String path = '/store/$storeId';
    if (productId != null) {
      path += '?productId=$productId';
    }
    return path;
  }

  static String categoryDetailPath(String categoryId) {
    return '/category/$categoryId';
  }
}

====================
فایل: service_locator.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\config\service_locator.dart
====================

import 'package:get_it/get_it.dart';
import 'package:http/http.dart' as http;
import 'package:persia_markt/core/services/api_service.dart';
import 'package:persia_markt/core/services/location_service.dart';
import 'package:persia_markt/features/auth/data/services/auth_service.dart'; // <-- ۱. سرویس جدید اضافه شد
import 'package:persia_markt/features/auth/presentation/cubit/auth_cubit.dart'; // <-- ۲. کیوبیت جدید اضافه شد
import 'package:persia_markt/features/home/data/repositories/market_repository_impl.dart';
import 'package:persia_markt/features/home/domain/repositories/market_repository.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/cubit/location_cubit.dart';
import 'package:persia_markt/features/profile/presentation/cubit/favorites_cubit.dart';
import 'package:persia_markt/features/search/presentation/cubit/search_cubit.dart';
import 'package:shared_preferences/shared_preferences.dart';

final sl = GetIt.instance;

Future<void> setupServiceLocator() async {
  // External
  final sharedPreferences = await SharedPreferences.getInstance();
  sl.registerLazySingleton(() => sharedPreferences);
  sl.registerLazySingleton(() => http.Client());

  // Services
  sl.registerLazySingleton(() => ApiService(client: sl()));
  sl.registerLazySingleton(() => LocationService());
  // ۳. سرویس احراز هویت ثبت شد
  sl.registerLazySingleton(() => AuthService(client: sl(), prefs: sl()));

  // Repositories
  sl.registerLazySingleton<MarketRepository>(() => MarketRepositoryImpl(apiService: sl()));

  // Blocs / Cubits
  sl.registerFactory(() => MarketDataBloc(marketRepository: sl()));
  sl.registerFactory(() => LocationCubit(locationService: sl()));
  sl.registerFactory(() => FavoritesCubit(sharedPreferences: sl()));
  sl.registerFactory(() => SearchCubit());
  // ۴. کیوبیت احراز هویت ثبت شد
  sl.registerFactory(() => AuthCubit(authService: sl()));
}


====================
فایل: locale_cubit.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\cubit\locale_cubit.dart
====================

// مسیر: lib/core/cubit/locale_cubit.dart

import 'package:flutter/material.dart'; // <<<--- مشکل اصلی اینجا بود و برطرف شد
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:shared_preferences/shared_preferences.dart';

class LocaleCubit extends Cubit<Locale> {
  // زبان پیش‌فرض را فارسی قرار می‌دهیم
  LocaleCubit() : super(const Locale('fa')) {
    _loadLocale();
  }

  // این متد در ابتدای کار، زبان ذخیره شده را از حافظه می‌خواند
  void _loadLocale() async {
    final prefs = await SharedPreferences.getInstance();
    // اگر زبانی ذخیره نشده بود، همان فارسی باقی می‌ماند
    final languageCode = prefs.getString('language_code') ?? 'fa';
    emit(Locale(languageCode));
  }

  // این متد زبان برنامه را تغییر داده و در حافظه ذخیره می‌کند
  void changeLocale(String languageCode) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('language_code', languageCode);
    emit(Locale(languageCode));
  }
}

====================
فایل: api_service.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\data\data_sources\api_service.dart
====================

// مسیر: lib/core/data/data_sources/api_service.dart

import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:persia_markt/core/config/service_locator.dart';
import 'package:persia_markt/core/cubit/locale_cubit.dart';
import 'package:persia_markt/core/data/models/market_data_model.dart'; // ۱. import مدل MarketData اضافه شد
import 'package:persia_markt/core/error/exceptions.dart';

class ApiService {
  final http.Client client;
  // ۲. آدرس پایه سرور دوباره تعریف شد
  final String _baseUrl = 'http://192.168.178.68:3000/api/v1/public';

  ApiService({required this.client});

  Future<MarketData> getMarketData() async {
    try {
      // ۳. زبان فعلی از LocaleCubit خوانده می‌شود
      final currentLocale = sl<LocaleCubit>().state;
      final languageCode = currentLocale.languageCode;

      final response = await client.get(
        Uri.parse('$_baseUrl/market-data'),
        headers: {
          'Content-Type': 'application/json',
          'Accept-Language': languageCode, // هدر زبان به درخواست اضافه شد
        },
      );

      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        // ۴. پاسخ سرور به مدل MarketData تبدیل می‌شود
        return MarketData.fromJson(data);
      } else {
        throw ServerException('Failed to load market data: ${response.statusCode}');
      }
    } catch (e) {
      throw ServerException('Failed to connect to the server: $e');
    }
  }
}

====================
فایل: market_data_model.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\data\models\market_data_model.dart
====================

// مسیر: lib/core/data/models/market_data_model.dart

import 'package:persia_markt/core/models/category_item.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/models/store.dart';

class MarketData {
  final List<CategoryItem> categories;
  final List<Store> stores;
  final List<Product> products;
  final List<Product> specialOfferProducts;
  final List<Product> affordableProducts;
  final List<dynamic> banners; // Assuming banners can be of any type for now

  MarketData({
    required this.categories,
    required this.stores,
    required this.products,
    required this.specialOfferProducts,
    required this.affordableProducts,
    required this.banners,
  });

  factory MarketData.fromJson(Map<String, dynamic> json) {
    return MarketData(
      categories: (json['categories'] as List)
          .map((i) => CategoryItem.fromJson(i))
          .toList(),
      stores: (json['stores'] as List).map((i) => Store.fromJson(i)).toList(),
      products: (json['products'] as List).map((i) => Product.fromJson(i)).toList(),
      specialOfferProducts: (json['specialOfferProducts'] as List)
          .map((i) => Product.fromJson(i))
          .toList(),
      affordableProducts: (json['affordableProducts'] as List)
          .map((i) => Product.fromJson(i))
          .toList(),
      banners: json['banners'] as List,
    );
  }
}

====================
فایل: exceptions.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\error\exceptions.dart
====================

// مسیر: lib/core/error/exceptions.dart

class ServerException implements Exception {
  final String message;
  ServerException(this.message);
}

class CacheException implements Exception {}

====================
فایل: failures.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\error\failures.dart
====================

// lib/core/error/failures.dart
import 'package:equatable/equatable.dart';

/// Base class for all failures in the application.
/// A Failure represents an unexpected error (e.g., server error, network error).
abstract class Failure extends Equatable {
  final String message;
  const Failure(this.message);

  @override
  List<Object> get props => [message];
}

/// Represents a failure that occurs when communicating with the server.
class ServerFailure extends Failure {
  const ServerFailure(String message) : super(message);
}

/// Represents a failure related to network connectivity issues.
class NetworkFailure extends Failure {
  const NetworkFailure(String message) : super(message);
}

====================
فایل: category_item.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\models\category_item.dart
====================

import 'package:equatable/equatable.dart';

class CategoryItem extends Equatable {
  final String id;
  final String name;
  final String nameEn;
  final String? description;
  final String? iconUrl;

  const CategoryItem({
    required this.id,
    required this.name,
    required this.nameEn,
    this.description,
    this.iconUrl,
  });

  @override
  List<Object?> get props => [id, name];

  factory CategoryItem.fromJson(Map<String, dynamic> json) {
    return CategoryItem(
      // FIXED: Safely convert the integer ID from the API to a String.
      id: json['id'].toString(),
      name: json['name'] as String,
      nameEn: json['name_en'] as String,
      description: json['description'] as String?,
      iconUrl: json['icon_url'] as String?,
    );
  }
}


====================
فایل: location.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\models\location.dart
====================

// lib/core/models/location.dart
import 'package:equatable/equatable.dart';

class Location extends Equatable {
  final double lat;
  final double lng;

  const Location({required this.lat, required this.lng});

  @override
  List<Object> get props => [lat, lng];

  factory Location.fromJson(Map<String, dynamic> json) {
    return Location(
      lat: (json['lat'] as num).toDouble(),
      lng: (json['lng'] as num).toDouble(),
    );
  }
}

====================
فایل: market_data.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\models\market_data.dart
====================

import 'package:equatable/equatable.dart';
import 'category_item.dart';
import 'product.dart';
import 'store.dart';

class MarketData extends Equatable {
  final List<Store> stores;
  final List<CategoryItem> categories;
  final List<Product> products;

  const MarketData({
    required this.stores,
    required this.categories,
    required this.products,
  });

  @override
  List<Object> get props => [stores, categories, products];

  /// Creates a MarketData instance from a JSON object.
  /// It safely handles potential errors during parsing of its child lists.
  factory MarketData.fromJson(Map<String, dynamic> json) {
    // Helper function to safely parse a list of items
    List<T> _parseList<T>(String key, T Function(Map<String, dynamic>) fromJson) {
      try {
        if (json[key] is List) {
          return (json[key] as List).map((item) => fromJson(item)).toList();
        }
      } catch (e) {
        print('Error parsing list for key "$key": $e');
      }
      return []; // Return an empty list on failure
    }

    return MarketData(
      stores: _parseList('stores', Store.fromJson),
      categories: _parseList('categories', CategoryItem.fromJson),
      products: _parseList('products', Product.fromJson),
    );
  }
}


====================
فایل: product.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\models\product.dart
====================

import 'package:equatable/equatable.dart';

class Product extends Equatable {
  final String id;
  final String storeID;
  final String name;
  final String description;
  final String brand;
  final List<String> images;
  final double price;
  final double? discountPrice;
  final int stock;
  final bool isPerishable;
  final String categoryID;

  const Product({
    required this.id,
    required this.storeID,
    required this.name,
    required this.description,
    required this.brand,
    required this.images,
    required this.price,
    this.discountPrice,
    required this.stock,
    required this.isPerishable,
    required this.categoryID,
  });

  /// A helper getter to return the primary image URL.
  String get primaryImageUrl => images.isNotEmpty ? images.first : '';

  /// A helper getter to determine the effective price (discounted or original).
  double get effectivePrice => discountPrice ?? price;

  /// A helper getter to check if the product is on sale.
  bool get isOnSale => discountPrice != null && discountPrice! < price;

  @override
  List<Object?> get props => [id, storeID, name, effectivePrice];

  /// Creates a Product instance from a JSON object received from the API.
  /// This factory is designed to parse the new nested API structure safely.
  factory Product.fromJson(Map<String, dynamic> json) {
    // Safely access the nested 'product' object.
    final productData = json['product'] as Map<String, dynamic>? ?? {};

    // Helper function to safely parse string prices to double.
    double? _parseDouble(dynamic value) {
      if (value == null) return null;
      return double.tryParse(value.toString());
    }

    return Product(
      id: json['id']?.toString() ?? 'unknown_id',
      storeID: json['storeID']?.toString() ?? 'unknown_store',
      price: _parseDouble(json['price']) ?? 0.0,
      discountPrice: _parseDouble(json['discount_price']),
      stock: json['stock'] as int? ?? 0,
      name: productData['name'] as String? ?? 'Unnamed Product',
      images: (productData['images'] as List<dynamic>?)?.map((e) => e.toString()).toList() ?? [],
      brand: productData['brand'] as String? ?? 'Unknown Brand',
      description: productData['description'] as String? ?? '',
      isPerishable: productData['is_perishable'] as bool? ?? false,
      // Safely parse category_id which comes as an integer from the backend.
      categoryID: productData['category_id']?.toString() ?? 'uncategorized',
    );
  }
}


====================
فایل: store.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\models\store.dart
====================

import 'package:equatable/equatable.dart';

class Store extends Equatable {
  final String storeID;
  final String name;
  final String address;
  final String storeImage;
  final double latitude;
  final double longitude;
  final double rating;

  // فیلدهای اضافی که ممکن است در آینده از API بیایند
  final String? city;
  final String? phone;

  const Store({
    required this.storeID,
    required this.name,
    required this.address,
    required this.storeImage,
    required this.latitude,
    required this.longitude,
    required this.rating,
    this.city,
    this.phone,
  });

  /// برای مواقعی که نیاز به Store خالی داریم
  factory Store.empty() {
    return const Store(
      storeID: '',
      name: 'Not Found',
      address: '',
      storeImage: '',
      latitude: 0.0,
      longitude: 0.0,
      rating: 0.0,
    );
  }

  @override
  List<Object?> get props => [storeID, name, address];

  /// Creates a Store instance from a JSON object.
  /// This factory is now updated to match the backend API response keys.
  factory Store.fromJson(Map<String, dynamic> json) {
    // Helper to safely parse numbers
    double _parseDouble(dynamic value) {
      if (value is num) return value.toDouble();
      if (value is String) return double.tryParse(value) ?? 0.0;
      return 0.0;
    }

    return Store(
      // FIXED: Mapped API keys to model properties
      storeID: (json['id'] as int).toString(),
      name: json['store_name'] as String? ?? 'Unnamed Store',
      address: json['store_address'] as String? ?? 'No address',
      storeImage: json['store_image_url'] as String? ?? '',
      latitude: _parseDouble(json['latitude']),
      longitude: _parseDouble(json['longitude']),
      rating: _parseDouble(json['rating']),
      city: json['city'] as String?, // Optional field
      phone: json['phone'] as String?, // Optional field
    );
  }
}


====================
فایل: api_service.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\services\api_service.dart
====================

import 'dart:convert'; // FIXED: Corrected the import statement
import 'package:http/http.dart' as http;
import 'dart:async'; // For timeout

/// A service class for handling all network requests to the PersiaMarkt API.
/// It is optimized to fetch initial data concurrently and handles server cold starts.
class ApiService {
  final String _baseUrl = 'https://persia-market-panel.onrender.com';
  final http.Client _client;
  // Increased timeout to handle server cold starts on free hosting tiers.
  final _timeoutDuration = const Duration(seconds: 90);

  ApiService({required http.Client client}) : _client = client;

  Future<Map<String, dynamic>> fetchMarketDataAsJson() async {
    try {
      print("Fetching market data... This might take a minute on the first load.");
      
      // 1. Fetch stores and categories concurrently with an extended timeout.
      final responses = await Future.wait([
        _client.get(Uri.parse('$_baseUrl/stores')).timeout(_timeoutDuration),
        _client.get(Uri.parse('$_baseUrl/categories')).timeout(_timeoutDuration),
      ]);

      final storesResponse = responses[0];
      final categoriesResponse = responses[1];

      // 2. Validate responses.
      if (storesResponse.statusCode != 200) {
        throw Exception('Failed to load stores: ${storesResponse.body}');
      }
      if (categoriesResponse.statusCode != 200) {
        throw Exception('Failed to load categories: ${categoriesResponse.body}');
      }

      final List<dynamic> storesJson = json.decode(utf8.decode(storesResponse.bodyBytes));
      final List<dynamic> categoriesJson = json.decode(utf8.decode(categoriesResponse.bodyBytes));

      if (storesJson.isEmpty) {
         print("Warning: No stores found from API.");
         return { 'stores': [], 'products': [], 'categories': categoriesJson };
      }

      // 3. Fetch products for each store concurrently.
      final productFutures = storesJson.map((storeJson) {
        final storeId = storeJson['id'];
        return _client.get(Uri.parse('$_baseUrl/stores/$storeId/products'))
            .timeout(_timeoutDuration)
            .then((response) {
          if (response.statusCode == 200) {
            final List<dynamic> productsJson = json.decode(utf8.decode(response.bodyBytes));
            for (var productJson in productsJson) {
              productJson['storeID'] = storeId.toString();
            }
            return productsJson;
          }
          print('Warning: Failed to load products for store ID $storeId');
          return <dynamic>[];
        });
      }).toList();

      final List<List<dynamic>> productsByStore = await Future.wait(productFutures);
      final List<dynamic> allProductsJson = productsByStore.expand((products) => products).toList();

      print("Market data fetched successfully!");
      return {
        'stores': storesJson,
        'products': allProductsJson,
        'categories': categoriesJson,
      };
    } on TimeoutException {
        print("Error: The request to the server timed out. This can happen on the first load.");
        throw Exception('سرور پاسخ نمی‌دهد. لطفاً چند لحظه بعد دوباره تلاش کنید.');
    } catch (e) {
      print('Error fetching market data: $e');
      throw Exception('خطا در اتصال به سرور. لطفاً از اتصال اینترنت خود مطمئن شوید.');
    }
  }
}


====================
فایل: location_service.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\services\location_service.dart
====================

// lib/services/location_service.dart
import 'package:geolocator/geolocator.dart';
import 'package:geocoding/geocoding.dart';

class LocationService {
  /// موقعیت فعلی دستگاه را با بررسی کامل دسترسی‌ها مشخص می‌کند.
  Future<Position> getCurrentPosition() async {
    // 1. بررسی فعال بودن سرویس موقعیت‌یاب دستگاه
    bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
    if (!serviceEnabled) {
      return Future.error('سرویس موقعیت مکانی غیرفعال است.');
    }

    // 2. بررسی و درخواست دسترسی موقعیت مکانی از کاربر
    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission == LocationPermission.denied) {
        return Future.error('دسترسی به موقعیت مکانی رد شد.');
      }
    }

    if (permission == LocationPermission.deniedForever) {
      return Future.error('دسترسی به موقعیت مکانی برای همیشه رد شده است.');
    }

    // 3. در صورت تایید دسترسی، موقعیت فعلی را برمی‌گرداند
    return await Geolocator.getCurrentPosition();
  }

  /// یک موقعیت جغرافیایی را به یک آدرس خوانا تبدیل می‌کند.
  Future<String> getAddressFromPosition(Position position) async {
    try {
      List<Placemark> placemarks = await placemarkFromCoordinates(position.latitude, position.longitude);

      if (placemarks.isNotEmpty) {
        final placemark = placemarks.first; 
        
        // بخش‌های مختلف آدرس را استخراج می‌کند
        final city = placemark.locality ?? ''; 
        final street = placemark.thoroughfare ?? ''; 
        
        // آدرس را به صورت خوانا ترکیب می‌کند
        final addressParts = [city, street].where((part) => part.isNotEmpty).toList();
        if (addressParts.isNotEmpty) {
          return addressParts.join(', ');
        }
      }
      // اگر هیچ آدرسی یافت نشد
      return 'موقعیت نامعلوم'; 
    } catch (e) {
      // دستور print برای محیط نهایی (production) حذف شد.
      // در صورت بروز خطا، یک پیام مناسب به کاربر نمایش داده می‌شود.
      return 'خطا در تبدیل موقعیت';
    }
  }
}

====================
فایل: error_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\widgets\error_view.dart
====================

import 'package:flutter/material.dart';

/// A reusable widget to display an error message with an optional retry button.
class AppErrorView extends StatelessWidget {
  final String message;
  final VoidCallback? onRetry;

  const AppErrorView({
    Key? key,
    required this.message,
    this.onRetry,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.cloud_off_rounded,
              color: Colors.red.shade300,
              size: 60,
            ),
            const SizedBox(height: 16),
            Text(
              'متاسفانه خطایی رخ داد!',
              style: Theme.of(context).textTheme.headlineSmall,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(
              message,
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(color: Colors.grey.shade600),
              textAlign: TextAlign.center,
            ),
            if (onRetry != null) ...[
              const SizedBox(height: 24),
              ElevatedButton.icon(
                onPressed: onRetry,
                icon: const Icon(Icons.refresh),
                label: const Text('تلاش مجدد'),
              ),
            ],
          ],
        ),
      ),
    );
  }
}


====================
فایل: loading_shimmer.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\widgets\loading_shimmer.dart
====================

// lib/core/widgets/loading_shimmer.dart
import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';

/// A reusable shimmer box widget to indicate loading state.
class ShimmerBox extends StatelessWidget {
  final double width;
  final double height;
  final ShapeBorder shape;

  const ShimmerBox({
    Key? key,
    required this.width,
    required this.height,
    this.shape = const RoundedRectangleBorder(),
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    bool isDarkMode = Theme.of(context).brightness == Brightness.dark;
    return Shimmer.fromColors(
      baseColor: isDarkMode ? Colors.grey.shade800 : Colors.grey.shade300,
      highlightColor: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade100,
      child: Container(
        width: width,
        height: height,
        decoration: ShapeDecoration(
          color: Colors.grey,
          shape: shape,
        ),
      ),
    );
  }
}

====================
فایل: product_card_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\widgets\product_card_view.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/models/store.dart';
import 'package:persia_markt/features/profile/presentation/cubit/favorites_cubit.dart';
import 'package:persia_markt/features/profile/presentation/cubit/favorites_state.dart';

/// A card widget to display a product in a compact, column-based layout.
/// Used in horizontal carousels.
class ProductCardView extends StatelessWidget {
  final Product product;
  final Store store;

  const ProductCardView({super.key, required this.product, required this.store});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () => context.go('/store/${store.storeID}?productId=${product.id}'),
      child: Container(
        width: 160,
        margin: const EdgeInsets.symmetric(horizontal: 8),
        decoration: BoxDecoration(
          color: Theme.of(context).cardColor,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.05),
              spreadRadius: 1,
              blurRadius: 5,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Product Image Section
            Stack(
              children: [
                ClipRRect(
                  borderRadius: const BorderRadius.vertical(top: Radius.circular(12)),
                  child: Container(
                    height: 120,
                    width: double.infinity,
                    color: Colors.grey.shade100,
                    child: Image.network(
                      // FIXED: Use the new primaryImageUrl getter.
                      product.primaryImageUrl,
                      fit: BoxFit.contain,
                      errorBuilder: (_, __, ___) => Image.asset(
                        'assets/images/supermarket.png',
                        fit: BoxFit.contain,
                      ),
                    ),
                  ),
                ),
                Positioned(
                  top: 4,
                  left: 4,
                  child: BlocBuilder<FavoritesCubit, FavoritesState>(
                    builder: (context, state) {
                      final isLiked = state.productIds.contains(product.id);
                      return IconButton(
                        onPressed: () => context.read<FavoritesCubit>().toggleLike(product.id),
                        icon: Icon(
                          isLiked ? Icons.favorite : Icons.favorite_border,
                          color: isLiked ? Colors.red : Colors.grey.shade400,
                          size: 24,
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
            // Product Details Section
            Padding(
              padding: const EdgeInsets.all(8.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    product.name,
                    style: const TextStyle(fontWeight: FontWeight.bold),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    store.name,
                    style: TextStyle(fontSize: 12, color: Colors.grey.shade600),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 8),
                  Align(
                    alignment: Alignment.centerRight,
                    child: Text(
                      // FIXED: Use effectivePrice to show discount if available.
                      '€${product.effectivePrice.toStringAsFixed(2)}',
                      style: TextStyle(
                        color: product.isOnSale ? Colors.red.shade700 : Colors.green.shade700,
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}


====================
فایل: product_list_item_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\widgets\product_list_item_view.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/models/store.dart';
import 'package:persia_markt/features/profile/presentation/cubit/favorites_cubit.dart';
import 'package:persia_markt/features/profile/presentation/cubit/favorites_state.dart';

class ProductListItemView extends StatelessWidget {
  final Product product;
  final Store store;
  final VoidCallback? onImageTap;

  const ProductListItemView({
    super.key,
    required this.product,
    required this.store,
    this.onImageTap,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 1,
      margin: const EdgeInsets.symmetric(vertical: 4, horizontal: 16),
      child: ListTile(
        onTap: () => context.go('/store/${store.storeID}?productId=${product.id}'),
        leading: GestureDetector(
          onTap: onImageTap,
          child: ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: Image.network(
              // FIXED: Use the new primaryImageUrl getter.
              product.primaryImageUrl,
              width: 60,
              height: 60,
              fit: BoxFit.cover,
              errorBuilder: (_, __, ___) => Image.asset(
                'assets/images/supermarket.png',
                width: 60,
                height: 60,
                fit: BoxFit.cover,
              ),
            ),
          ),
        ),
        title: Text(
          product.name,
          style: Theme.of(context).textTheme.titleMedium?.copyWith(fontWeight: FontWeight.bold),
        ),
        subtitle: Text(
          product.description,
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
        ),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              // FIXED: Use effectivePrice to show discount if available.
              '€${product.effectivePrice.toStringAsFixed(2)}',
              style: TextStyle(
                color: product.isOnSale ? Colors.red : Colors.green,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(width: 8),
            _FavoriteButton(productId: product.id),
          ],
        ),
      ),
    );
  }
}

class _FavoriteButton extends StatelessWidget {
  final String productId;
  const _FavoriteButton({required this.productId});

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<FavoritesCubit, FavoritesState>(
      builder: (context, state) {
        final isLiked = state.productIds.contains(productId);
        return IconButton(
          onPressed: () => context.read<FavoritesCubit>().toggleLike(productId),
          icon: Icon(
            isLiked ? Icons.favorite : Icons.favorite_border,
            color: isLiked ? Colors.red : Colors.grey,
          ),
        );
      },
    );
  }
}


====================
فایل: store_list_item_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\core\widgets\store_list_item_view.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:geolocator/geolocator.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/models/store.dart';
import 'package:persia_markt/features/home/presentation/cubit/location_cubit.dart';
import 'package:persia_markt/features/home/presentation/cubit/location_state.dart';
import 'package:persia_markt/l10n/app_localizations.dart'; // ۱. Import برای ترجمه

class StoreListItemView extends StatelessWidget {
  final Store store;
  const StoreListItemView({super.key, required this.store});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!; // ۲. نمونه l10n

    return Container(
      margin: const EdgeInsets.symmetric(vertical: 6, horizontal: 16),
      decoration: BoxDecoration(
        color: Theme.of(context).cardColor,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.08),
            blurRadius: 10,
            spreadRadius: 1,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12),
        child: ListTile(
          onTap: () => context.go('/store/${store.storeID}'),
          leading: ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: Image.network(
              store.storeImage,
              width: 60,
              height: 60,
              fit: BoxFit.cover,
              errorBuilder: (context, error, stackTrace) => Image.asset(
                'assets/images/supermarket.png',
                width: 60,
                height: 60,
                fit: BoxFit.cover,
              ),
            ),
          ),
          title: Text(
            store.name,
            style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  fontWeight: FontWeight.bold,
                  fontSize: 18,
                ),
          ),
          subtitle: Text(
            '${store.address}, ${store.city}',
            overflow: TextOverflow.ellipsis,
          ),
          trailing: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Icon(Icons.star, color: Colors.amber, size: 16),
                  const SizedBox(width: 4),
                  // ۳. متن امتیاز با l10n ترکیب شد
                  Text('${store.rating} ${l10n.storeRating}'),
                ],
              ),
              const SizedBox(height: 4),
              BlocBuilder<LocationCubit, LocationState>(
                builder: (context, locationState) {
                  if (locationState is LocationLoaded) {
                    final distance = Geolocator.distanceBetween(
                      locationState.position.latitude,
                      locationState.position.longitude,
                      store.latitude,
                      store.longitude,
                    );
                    // ۴. متن فاصله و واحد "کیلومتر" ترجمه شد
                    final distanceText = '${(distance / 1000).toStringAsFixed(1)} ${l10n.km}';
                    return Text(
                      distanceText,
                      style: const TextStyle(fontSize: 12, color: Colors.grey),
                    );
                  }
                  return const SizedBox.shrink();
                },
              ),
            ],
          ),
        ),
      ),
    );
  }
}

====================
فایل: auth_service.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\auth\data\services\auth_service.dart
====================

import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';

class AuthService {
  final String _baseUrl = 'https://persia-market-panel.onrender.com';
  final http.Client _client;
  final SharedPreferences _prefs;

  // Key to store the auth token locally
  static const String _tokenKey = 'auth_token';

  AuthService({required http.Client client, required SharedPreferences prefs})
      : _client = client,
        _prefs = prefs;

  Future<String> register({
    required String name,
    required String email,
    required String password,
    String? city,
  }) async {
    final response = await _client.post(
      Uri.parse('$_baseUrl/auth/user/register'), // آدرس صحیح برای ثبت‌نام کاربر
      headers: {'Content-Type': 'application/json'},
      body: json.encode({
        'name': name,
        'email': email,
        'password': password,
        'city': city ?? '',
      }),
    );

    final responseBody = json.decode(response.body);
    if (response.statusCode >= 200 && response.statusCode < 300) {
      return 'ثبت‌نام با موفقیت انجام شد.';
    } else {
      throw Exception(responseBody['message'] ?? 'خطا در ثبت‌نام');
    }
  }

  Future<String> login({required String email, required String password}) async {
    final response = await _client.post(
      // --- مشکل اینجا بود ---
      // آدرس ورود از /auth/login به /auth/user/login اصلاح شد
      Uri.parse('$_baseUrl/auth/user/login'),
      headers: {'Content-Type': 'application/json'},
      body: json.encode({'email': email, 'password': password}),
    );

    final responseBody = json.decode(response.body);
    if (response.statusCode >= 200 && response.statusCode < 300) {
      final token = responseBody['access_token'];
      await _prefs.setString(_tokenKey, token);
      return token;
    } else {
      throw Exception(responseBody['message'] ?? 'خطا در ورود');
    }
  }

  Future<void> logout() async {
    await _prefs.remove(_tokenKey);
  }

  String? getToken() {
    return _prefs.getString(_tokenKey);
  }

  bool isLoggedIn() {
    return _prefs.containsKey(_tokenKey);
  }
}


====================
فایل: auth_cubit.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\auth\presentation\cubit\auth_cubit.dart
====================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/features/auth/data/services/auth_service.dart';
import 'auth_state.dart';

class AuthCubit extends Cubit<AuthState> {
  // FIXED: Made authService public by removing the underscore.
  final AuthService authService;

  AuthCubit({required this.authService}) : super(AuthInitial()) {
    checkAuthentication();
  }

  // Checks if a token exists locally to determine initial auth state.
  void checkAuthentication() {
    if (authService.isLoggedIn()) {
      emit(const Authenticated());
    } else {
      emit(Unauthenticated());
    }
  }

  Future<void> registerUser({
    required String name,
    required String email,
    required String password,
    String? city,
  }) async {
    emit(AuthLoading());
    try {
      await authService.register(
        name: name,
        email: email,
        password: password,
        city: city,
      );
      // After successful registration, move to Unauthenticated to prompt login
      emit(Unauthenticated());
    } catch (e) {
      emit(AuthError(e.toString().replaceAll('Exception: ', '')));
    }
  }

  Future<void> loginUser({
    required String email,
    required String password,
  }) async {
    emit(AuthLoading());
    try {
      await authService.login(email: email, password: password);
      emit(const Authenticated());
    } catch (e) {
      emit(AuthError(e.toString().replaceAll('Exception: ', '')));
    }
  }

  Future<void> logoutUser() async {
    await authService.logout();
    emit(Unauthenticated());
  }
}


====================
فایل: auth_state.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\auth\presentation\cubit\auth_state.dart
====================

import 'package:equatable/equatable.dart';

// An abstract class for all authentication states
abstract class AuthState extends Equatable {
  const AuthState();

  @override
  List<Object> get props => [];
}

// Initial state, user is not authenticated
class AuthInitial extends AuthState {}

// State when an auth process (login/register) is in progress
class AuthLoading extends AuthState {}

// State when the user is successfully authenticated
class Authenticated extends AuthState {
  // You can add user data here later, e.g., final User user;
  const Authenticated();
}

// State when the user is not authenticated (e.g., after logout or failed login)
class Unauthenticated extends AuthState {}

// State when an error occurs during the auth process
class AuthError extends AuthState {
  final String message;

  const AuthError(this.message);

  @override
  List<Object> get props => [message];
}


====================
فایل: login_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\auth\presentation\view\login_view.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/config/app_routes.dart';
import 'package:persia_markt/core/cubit/locale_cubit.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_cubit.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_state.dart';
import 'package:persia_markt/l10n/app_localizations.dart';

class LoginView extends StatefulWidget {
  const LoginView({super.key});

  @override
  State<LoginView> createState() => _LoginViewState();
}

class _LoginViewState extends State<LoginView> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _isLoadingUi = false;
  bool _obscureText = true;

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  void _togglePasswordVisibility() {
    setState(() {
      _obscureText = !_obscureText;
    });
  }

  Future<void> _login() async {
    if (_formKey.currentState?.validate() ?? false) {
      context.read<AuthCubit>().loginUser(
            email: _emailController.text.trim(),
            password: _passwordController.text,
          );
      setState(() => _isLoadingUi = true);
    }
  }

  void _showLanguageDialog(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    showDialog(
      context: context,
      builder: (BuildContext dialogContext) {
        return SimpleDialog(
          title: Text(l10n.selectLanguage),
          children: <Widget>[
            SimpleDialogOption(
              onPressed: () {
                context.read<LocaleCubit>().changeLocale('fa');
                Navigator.pop(dialogContext);
              },
              child: Text(l10n.persian),
            ),
            SimpleDialogOption(
              onPressed: () {
                context.read<LocaleCubit>().changeLocale('en');
                Navigator.pop(dialogContext);
              },
              child: Text(l10n.english),
            ),
            SimpleDialogOption(
              onPressed: () {
                context.read<LocaleCubit>().changeLocale('de');
                Navigator.pop(dialogContext);
              },
              child: Text(l10n.german),
            ),
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;
    final isRtl = l10n.localeName == 'fa';

    return Scaffold(
      body: SafeArea(
        child: BlocConsumer<AuthCubit, AuthState>(
          listener: (context, state) {
            if (state is Authenticated) {
              context.go(AppRoutes.home);
            } else if (state is AuthError) {
              setState(() => _isLoadingUi = false);
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text(state.message)),
              );
            } else if (state is Unauthenticated || state is AuthInitial) {
              setState(() => _isLoadingUi = false);
            }
          },
          builder: (context, state) {
            final isLoading = state is AuthLoading || _isLoadingUi;

            return Stack(
              children: [
                Center(
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.all(24.0),
                    child: Form(
                      key: _formKey,
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        crossAxisAlignment: CrossAxisAlignment.stretch,
                        children: [
                          const SizedBox(height: 50),
                          Image.asset('assets/images/appLogo.png', height: 80),
                          const SizedBox(height: 16),
                          Text(
                            l10n.loginToYourAccount,
                            textAlign: TextAlign.center,
                            style: theme.textTheme.headlineMedium?.copyWith(fontWeight: FontWeight.bold),
                          ),
                          const SizedBox(height: 8),
                          Text(
                            l10n.gladToSeeYouAgain,
                            textAlign: TextAlign.center,
                            style: theme.textTheme.titleMedium?.copyWith(color: Colors.grey),
                          ),
                          const SizedBox(height: 32),
                          _buildTextFormField(
                            controller: _emailController,
                            labelText: l10n.email,
                            icon: Icons.email_outlined,
                            keyboardType: TextInputType.emailAddress,
                            validator: (value) {
                              if (value == null || value.trim().isEmpty) return l10n.enterYourEmail;
                              if (!value.contains('@') || !value.contains('.')) return l10n.invalidEmail;
                              return null;
                            },
                          ),
                          const SizedBox(height: 16),
                          _buildTextFormField(
                            controller: _passwordController,
                            labelText: l10n.password,
                            icon: Icons.lock_outline,
                            obscureText: _obscureText,
                            suffixIcon: IconButton(
                              icon: Icon(_obscureText ? Icons.visibility_off : Icons.visibility),
                              onPressed: _togglePasswordVisibility,
                            ),
                            validator: (value) {
                              if (value == null || value.isEmpty) return l10n.enterYourPassword;
                              if (value.length < 6) return l10n.passwordTooShort;
                              return null;
                            },
                          ),
                          const SizedBox(height: 24),
                          isLoading
                              ? const Center(child: CircularProgressIndicator())
                              : ElevatedButton(
                                  onPressed: _login,
                                  style: ElevatedButton.styleFrom(
                                    padding: const EdgeInsets.symmetric(vertical: 14),
                                  ),
                                  child: Text(l10n.login),
                                ),
                          const SizedBox(height: 12),
                          TextButton(
                            onPressed: () => context.go(AppRoutes.register),
                            child: Text(l10n.noAccount),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
                Positioned(
                  top: 16,
                  left: isRtl ? null : 16,
                  right: isRtl ? 16 : null,
                  child: TextButton.icon(
                    icon: const Icon(Icons.storefront_outlined, size: 20),
                    label: Text(l10n.sellerLogin),
                    // ==================== تغییر اصلی اینجاست ====================
                    onPressed: () => context.push(AppRoutes.sellerPanel),
                    // ==========================================================
                    style: _buttonStyle(theme),
                  ),
                ),
                Positioned(
                  top: 16,
                  right: isRtl ? null : 16,
                  left: isRtl ? 16 : null,
                  child: TextButton.icon(
                    icon: const Icon(Icons.language, size: 20),
                    label: Text(l10n.language),
                    onPressed: () => _showLanguageDialog(context),
                    style: _buttonStyle(theme),
                  ),
                ),
              ],
            );
          },
        ),
      ),
    );
  }

  ButtonStyle _buttonStyle(ThemeData theme) {
    return TextButton.styleFrom(
      foregroundColor: theme.colorScheme.primary,
      backgroundColor: theme.colorScheme.surface.withOpacity(0.9),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(20),
      ),
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
    );
  }

  Widget _buildTextFormField({
    required TextEditingController controller,
    required String labelText,
    required IconData icon,
    Widget? suffixIcon,
    TextInputType? keyboardType,
    bool obscureText = false,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller,
      decoration: InputDecoration(
        labelText: labelText,
        prefixIcon: Icon(icon),
        suffixIcon: suffixIcon,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
        ),
      ),
      keyboardType: keyboardType,
      obscureText: obscureText,
      validator: validator,
    );
  }
}

====================
فایل: register_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\auth\presentation\view\register_view.dart
====================

import 'package:flutter/material.dart'; // <-- FIXED
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_cubit.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_state.dart';

class RegisterView extends StatefulWidget {
  const RegisterView({super.key});

  @override
  State<RegisterView> createState() => _RegisterViewState();
}

class _RegisterViewState extends State<RegisterView> {
  final _formKey = GlobalKey<FormState>();
  final _nameController = TextEditingController();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _cityController = TextEditingController();
  bool _obscureText = true;

  @override
  void dispose() {
    _nameController.dispose();
    _emailController.dispose();
    _passwordController.dispose();
    _cityController.dispose();
    super.dispose();
  }

  void _togglePasswordVisibility() {
    setState(() {
      _obscureText = !_obscureText;
    });
  }

  void _register() {
    if (_formKey.currentState?.validate() ?? false) {
      context.read<AuthCubit>().registerUser(
            name: _nameController.text,
            email: _emailController.text,
            password: _passwordController.text,
            city: _cityController.text,
          );
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return Scaffold(
      body: SafeArea(
        child: BlocConsumer<AuthCubit, AuthState>(
          listener: (context, state) {
            if (state is AuthError) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text(state.message), backgroundColor: Colors.red),
              );
            } else if (state is Unauthenticated) {
              // This state is emitted after successful registration
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('ثبت‌نام با موفقیت انجام شد! لطفاً وارد شوید.')),
              );
              context.go('/login');
            }
          },
          builder: (context, state) {
            final isLoading = state is AuthLoading;
            return Center(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24.0),
                child: Form(
                  key: _formKey,
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      Image.asset('assets/images/appLogo.png', height: 80),
                      const SizedBox(height: 16),
                      Text(
                        'ساخت حساب کاربری',
                        textAlign: TextAlign.center,
                        style: theme.textTheme.headlineMedium?.copyWith(fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'به پرشیا مارکت خوش آمدید!',
                        textAlign: TextAlign.center,
                        style: theme.textTheme.titleMedium?.copyWith(color: Colors.grey),
                      ),
                      const SizedBox(height: 32),
                      _buildTextFormField(
                        controller: _nameController,
                        labelText: 'نام و نام خانوادگی',
                        icon: Icons.person_outline,
                        validator: (value) => (value?.isEmpty ?? true) ? 'لطفاً نام خود را وارد کنید' : null,
                      ),
                      const SizedBox(height: 16),
                      _buildTextFormField(
                        controller: _emailController,
                        labelText: 'ایمیل',
                        icon: Icons.email_outlined,
                        keyboardType: TextInputType.emailAddress,
                        validator: (value) {
                          if (value?.isEmpty ?? true) return 'لطفاً ایمیل خود را وارد کنید';
                          if (!RegExp(r'^[^@]+@[^@]+\.[^@]+').hasMatch(value!)) return 'ایمیل معتبر نیست';
                          return null;
                        },
                      ),
                      const SizedBox(height: 16),
                      _buildTextFormField(
                        controller: _passwordController,
                        labelText: 'رمز عبور',
                        icon: Icons.lock_outline,
                        obscureText: _obscureText,
                        suffixIcon: IconButton(
                          icon: Icon(_obscureText ? Icons.visibility_off_outlined : Icons.visibility_outlined),
                          onPressed: _togglePasswordVisibility,
                        ),
                        validator: (value) => (value?.length ?? 0) < 8 ? 'رمز عبور باید حداقل ۸ کاراکتر باشد' : null,
                      ),
                      const SizedBox(height: 16),
                      _buildTextFormField(
                        controller: _cityController,
                        labelText: 'شهر (اختیاری)',
                        icon: Icons.location_city_outlined,
                      ),
                      const SizedBox(height: 24),
                      isLoading
                          ? const Center(child: CircularProgressIndicator())
                          : ElevatedButton(
                              onPressed: _register,
                              style: ElevatedButton.styleFrom(
                                padding: const EdgeInsets.symmetric(vertical: 16),
                              ),
                              child: const Text('ثبت نام'),
                            ),
                      const SizedBox(height: 16),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          const Text('حساب کاربری دارید؟'),
                          TextButton(
                            onPressed: () => context.go('/login'),
                            child: const Text('وارد شوید'),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            );
          },
        ),
      ),
    );
  }

  TextFormField _buildTextFormField({
    required TextEditingController controller,
    required String labelText,
    required IconData icon,
    String? Function(String?)? validator,
    TextInputType? keyboardType,
    bool obscureText = false,
    Widget? suffixIcon,
  }) {
    return TextFormField(
      controller: controller,
      decoration: InputDecoration(
        labelText: labelText,
        prefixIcon: Icon(icon),
        suffixIcon: suffixIcon,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
        ),
      ),
      keyboardType: keyboardType,
      obscureText: obscureText,
      validator: validator,
    );
  }
}


====================
فایل: cart_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\cart\view\cart_view.dart
====================

// مسیر: lib/features/cart/view/cart_view.dart

import 'package:flutter/material.dart';
import 'package:persia_markt/l10n/app_localizations.dart';

// نکته: این یک ویجت نمونه است. شما باید منطق مربوط به Bloc را
// برای خواندن و مدیریت آیتم‌های سبد خرید به آن اضافه کنید.

class CartView extends StatelessWidget {
  const CartView({super.key});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    
    // این متغیر باید از Bloc خوانده شود
    final bool isCartEmpty = true; // برای نمونه، فرض می‌کنیم سبد خالی است

    return Scaffold(
      appBar: AppBar(
        // ۱. عنوان صفحه ترجمه شد
        title: Text(l10n.yourShoppingCart),
      ),
      body: isCartEmpty
          ? Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Icon(Icons.shopping_cart_outlined, size: 100, color: Colors.grey),
                  const SizedBox(height: 16),
                  Text(
                    // ۲. پیام سبد خالی ترجمه شد
                    l10n.yourCartIsEmpty,
                    style: Theme.of(context).textTheme.headlineSmall,
                  ),
                ],
              ),
            )
          : ListView.builder(
              // در اینجا منطق نمایش آیتم‌های سبد خرید قرار می‌گیرد
              itemCount: 0,
              itemBuilder: (context, index) {
                return const ListTile(title: Text('Product Item'));
              },
            ),
    );
  }
}

====================
فایل: category_detail_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\category\view\category_detail_view.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/config/app_routes.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/models/store.dart';
import 'package:persia_markt/core/widgets/product_card_view.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';
import 'package:persia_markt/l10n/app_localizations.dart';

class CategoryDetailView extends StatelessWidget {
  final String categoryId;
  const CategoryDetailView({super.key, required this.categoryId});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;

    return Directionality(
      textDirection: l10n.localeName == 'fa' ? TextDirection.rtl : TextDirection.ltr,
      child: Scaffold(
        body: BlocBuilder<MarketDataBloc, MarketDataState>(
          builder: (context, state) {
            if (state is MarketDataLoaded) {
              final category = state.marketData.categories
                  .where((c) => c.id == categoryId)
                  .firstOrNull;

              if (category == null) {
                return Center(child: Text('Category with ID $categoryId not found.'));
              }

              // 1. Filter products using the correct property name: categoryID
              final productsInCategory = state.marketData.products
                  .where((p) => p.categoryID == categoryId)
                  .toList();

              // 2. Find unique stores using the correct property name: storeID
              final storeIds = productsInCategory.map((p) => p.storeID).toSet();
              final stores = state.marketData.stores
                  // 3. Match stores using the correct property name: storeID
                  .where((s) => storeIds.contains(s.storeID))
                  .toList();

              return CustomScrollView(
                slivers: [
                  SliverAppBar(
                    title: Text(category.name),
                    pinned: true,
                    floating: true,
                  ),
                  if (stores.isEmpty)
                    SliverFillRemaining(
                      child: Center(child: Text(l10n.noProductsInCategory)),
                    )
                  else
                    SliverList.builder(
                      itemCount: stores.length,
                      itemBuilder: (context, index) {
                        final store = stores[index];
                        final productsInStore = productsInCategory
                            // 4. Filter products for the store using the correct property name: storeID
                            .where((p) => p.storeID == store.storeID)
                            .toList();

                        return _StoreProductsCard(store: store, products: productsInStore);
                      },
                    ),
                ],
              );
            }
            return const Center(child: CircularProgressIndicator());
          },
        ),
      ),
    );
  }
}

class _StoreProductsCard extends StatelessWidget {
  const _StoreProductsCard({
    required this.store,
    required this.products,
  });

  final Store store;
  final List<Product> products;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    return Card(
      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      elevation: 2,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Column(
        children: [
          ListTile(
            leading: CircleAvatar(
              backgroundImage: NetworkImage(store.storeImage),
              onBackgroundImageError: (_, __) {},
            ),
            title: Text(store.name, style: const TextStyle(fontWeight: FontWeight.bold)),
            subtitle: Text(store.address),
          ),
          SizedBox(
            height: 250,
            child: ListView.builder(
              scrollDirection: Axis.horizontal,
              itemCount: products.length,
              padding: const EdgeInsets.all(8),
              itemBuilder: (context, productIndex) {
                return ProductCardView(
                  product: products[productIndex],
                  store: store,
                );
              },
            ),
          ),
          Padding(
            padding: const EdgeInsets.all(8.0),
            child: Align(
              alignment: Alignment.centerLeft,
              child: ElevatedButton.icon(
                // 5. Navigate using the correct property name: storeID
                onPressed: () => context.go(AppRoutes.storeDetailPath(store.storeID)),
                icon: const Icon(Icons.storefront_outlined),
                label: Text(l10n.viewStore),
              ),
            ),
          )
        ],
      ),
    );
  }
}

====================
فایل: market_repository.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\data\repositories\market_repository.dart
====================

// lib/features/home/domain/repositories/market_repository.dart
import 'package:fpdart/fpdart.dart';
import 'package:persia_markt/core/error/failures.dart';
import 'package:persia_markt/core/models/market_data.dart';

/// Abstract contract for the market data repository.
/// This allows the business logic layer (BLoC) to depend on an abstraction,
/// not a concrete implementation, which is crucial for testing and modularity.
abstract class MarketRepository {
  /// Fetches the market data.
  /// Returns [Either] a [Failure] on error or [MarketData] on success.
  Future<Either<Failure, MarketData>> getMarketData();
}

====================
فایل: market_repository_impl.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\data\repositories\market_repository_impl.dart
====================

import 'package:fpdart/fpdart.dart';
import 'package:persia_markt/core/error/failures.dart';
import 'package:persia_markt/core/models/market_data.dart';
import 'package:persia_markt/core/services/api_service.dart';
import 'package:persia_markt/features/home/domain/repositories/market_repository.dart';

class MarketRepositoryImpl implements MarketRepository {
  final ApiService _apiService;

  const MarketRepositoryImpl({required ApiService apiService})
      : _apiService = apiService;

  @override
  Future<Either<Failure, MarketData>> getMarketData() async {
    try {
      // 1. Fetch the raw JSON data from the optimized ApiService.
      final Map<String, dynamic> marketDataJson =
          await _apiService.fetchMarketDataAsJson();

      // 2. Parse the JSON into a strongly-typed MarketData model.
      final marketData = MarketData.fromJson(marketDataJson);

      // 3. Return the successful result wrapped in a Right.
      return Right(marketData);
    } on Exception catch (e) {
      // 4. On any exception from the service layer, catch it and return
      //    a standardized ServerFailure with a user-friendly message.
      return Left(ServerFailure(e.toString().replaceAll('Exception: ', '')));
    }
  }
}


====================
فایل: market_repository.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\domain\repositories\market_repository.dart
====================

// lib/features/home/domain/repositories/market_repository.dart
import 'package:fpdart/fpdart.dart';
import 'package:persia_markt/core/error/failures.dart';
import 'package:persia_markt/core/models/market_data.dart';

/// Abstract contract for the market data repository.
/// This allows the business logic layer (BLoC) to depend on an abstraction,
/// not a concrete implementation, which is crucial for testing and modularity.
///
/// It defines what the repository *must do*, but not *how* it does it.
abstract class MarketRepository {
  /// Fetches the market data.
  /// Returns [Either] a [Failure] on error or [MarketData] on success.
  /// The Either type from fpdart provides excellent, explicit error handling.
  Future<Either<Failure, MarketData>> getMarketData();
}

====================
فایل: market_data_bloc.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\bloc\market_data_bloc.dart
====================

// lib/features/home/presentation/bloc/market_data_bloc.dart
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/features/home/domain/repositories/market_repository.dart';
import 'market_data_event.dart';
import 'market_data_state.dart';

class MarketDataBloc extends Bloc<MarketDataEvent, MarketDataState> {
  final MarketRepository _marketRepository;

  MarketDataBloc({required MarketRepository marketRepository})
      : _marketRepository = marketRepository,
        super(MarketDataInitial()) {
    // Register the event handler
    on<FetchMarketDataEvent>(_onFetchMarketData);
  }

  /// Handles the FetchMarketDataEvent.
  Future<void> _onFetchMarketData(
    FetchMarketDataEvent event,
    Emitter<MarketDataState> emit,
  ) async {
    emit(MarketDataLoading());
    final failureOrMarketData = await _marketRepository.getMarketData();
    
    // Use .fold for elegant handling of the Either<Failure, Success> type.
    // The first function handles the Left (Failure) case, the second handles the Right (Success) case.
    failureOrMarketData.fold(
      (failure) => emit(MarketDataError(message: failure.message)),
      (marketData) => emit(MarketDataLoaded(marketData: marketData)),
    );
  }
}

====================
فایل: market_data_event.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\bloc\market_data_event.dart
====================

// lib/features/home/presentation/bloc/market_data_event.dart
import 'package:equatable/equatable.dart';

abstract class MarketDataEvent extends Equatable {
  const MarketDataEvent();
  @override
  List<Object> get props => [];
}

/// Event to trigger fetching market data from the repository.
class FetchMarketDataEvent extends MarketDataEvent {}

====================
فایل: market_data_state.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\bloc\market_data_state.dart
====================

// lib/features/home/presentation/bloc/market_data_state.dart
import 'package:equatable/equatable.dart';
import 'package:persia_markt/core/models/market_data.dart';

abstract class MarketDataState extends Equatable {
  const MarketDataState();
  @override
  List<Object> get props => [];
}

class MarketDataInitial extends MarketDataState {}

class MarketDataLoading extends MarketDataState {}

class MarketDataLoaded extends MarketDataState {
  final MarketData marketData;
  const MarketDataLoaded({required this.marketData});
  @override
  List<Object> get props => [marketData];
}

class MarketDataError extends MarketDataState {
  final String message;
  const MarketDataError({required this.message});
  @override
  List<Object> get props => [message];
}

====================
فایل: location_cubit.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\cubit\location_cubit.dart
====================

// lib/features/home/presentation/cubit/location_cubit.dart
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/core/services/location_service.dart';
import 'location_state.dart';

/// Manages the state for user location.
/// It interacts with the LocationService to fetch the current position and address.
class LocationCubit extends Cubit<LocationState> {
  final LocationService _locationService;

  LocationCubit({required LocationService locationService})
      : _locationService = locationService,
        super(LocationInitial());

  /// Fetches the user's current location and address.
  /// Emits [LocationLoading], followed by [LocationLoaded] on success
  /// or [LocationError] on failure.
  Future<void> fetchLocation() async {
    emit(LocationLoading());
    try {
      final position = await _locationService.getCurrentPosition();
      final address = await _locationService.getAddressFromPosition(position);
      emit(LocationLoaded(position: position, address: address));
    } catch (e) {
      emit(LocationError(message: e.toString()));
    }
  }
}

====================
فایل: location_state.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\cubit\location_state.dart
====================

// lib/features/home/presentation/cubit/location_state.dart
import 'package:equatable/equatable.dart';
import 'package:geolocator/geolocator.dart';

/// Base class for all location-related states.
abstract class LocationState extends Equatable {
  const LocationState();
  @override
  List<Object?> get props => [];
}

/// The initial state before any location fetching has started.
class LocationInitial extends LocationState {}

/// The state while the location is being fetched.
class LocationLoading extends LocationState {}

/// The state when the location has been successfully fetched.
class LocationLoaded extends LocationState {
  final Position position;
  final String address;

  const LocationLoaded({required this.position, required this.address});

  @override
  List<Object?> get props => [position, address];
}

/// The state when an error occurs during location fetching.
class LocationError extends LocationState {
  final String message;

  const LocationError({required this.message});

  @override
  List<Object?> get props => [message];
}

====================
فایل: market_data_cubit.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\cubit\market_data_cubit.dart
====================

// lib/features/home/presentation/cubit/market_data_cubit.dart
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/core/services/api_service.dart';
import 'package:persia_markt/core/models/market_data.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';

class MarketDataCubit extends Cubit<MarketDataState> {
  final ApiService _apiService;

  MarketDataCubit({required ApiService apiService})
      : _apiService = apiService,
        super(MarketDataLoading()); // ← const حذف شد

  /// دریافت داده‌ی بازار و انتشار State مناسب
  Future<void> fetchMarketData() async {
    try {
      emit(MarketDataLoading()); // ← const حذف شد

      final Map<String, dynamic> json = await _apiService.fetchMarketDataAsJson();
      final MarketData data = MarketData.fromJson(json);

      emit(MarketDataLoaded(marketData: data));
    } catch (e) {
      emit(MarketDataError(message: 'خطا در دریافت اطلاعات: ${e.toString()}'));
    }
  }
}


====================
فایل: market_data_state.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\cubit\market_data_state.dart
====================

import 'package:equatable/equatable.dart';
import 'package:persia_markt/core/models/market_data.dart';

// کلاس پایه برای وضعیت‌ها
abstract class MarketDataState extends Equatable {
  const MarketDataState();

  @override
  List<Object> get props => [];
}

// وضعیت اولیه یا در حال بارگذاری
class MarketDataLoading extends MarketDataState {}

// وضعیت موفقیت آمیز بودن دریافت داده‌ها
class MarketDataLoaded extends MarketDataState {
  final MarketData marketData;

  const MarketDataLoaded({required this.marketData});

  @override
  List<Object> get props => [marketData];
}

// وضعیت بروز خطا
class MarketDataError extends MarketDataState {
  final String message;

  const MarketDataError({required this.message});

  @override
  List<Object> get props => [message];
}

====================
فایل: home_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\view\home_view.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/config/app_routes.dart';
import 'package:persia_markt/core/widgets/error_view.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_event.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';
// ۱. استفاده از نام‌های صحیح ویجت‌های شما
import 'package:persia_markt/features/home/presentation/widgets/affordable_products_section.dart';
import 'package:persia_markt/features/home/presentation/widgets/banner_carousel_view.dart';
import 'package:persia_markt/features/home/presentation/widgets/category_list_view.dart';
import 'package:persia_markt/features/home/presentation/widgets/home_header.dart';
import 'package:persia_markt/features/home/presentation/widgets/home_loading_shimmer.dart';
import 'package:persia_markt/features/home/presentation/widgets/section_divider.dart';
import 'package:persia_markt/features/home/presentation/widgets/stores_by_city_section.dart';
// ۲. استفاده از مسیر صحیح برای فایل ترجمه
import 'package:persia_markt/l10n/app_localizations.dart';

class HomeView extends StatelessWidget {
  const HomeView({super.key});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;

    return Directionality(
      textDirection: l10n.localeName == 'fa' ? TextDirection.rtl : TextDirection.ltr,
      child: Scaffold(
        body: BlocBuilder<MarketDataBloc, MarketDataState>(
          builder: (context, state) {
            if (state is MarketDataInitial) {
              return _InitialLoadingView(); // ویجت بارگذاری اولیه شما
            }
            if (state is MarketDataLoading) {
              return const HomeLoadingShimmer(); // ۳. استفاده از ویجت Shimmer شما
            }
            if (state is MarketDataError) {
              return AppErrorView(
                message: state.message,
                onRetry: () => context.read<MarketDataBloc>().add(FetchMarketDataEvent()),
              );
            }
            if (state is MarketDataLoaded) {
              final marketData = state.marketData;

              if (marketData.stores.isEmpty && marketData.categories.isEmpty) {
                return AppErrorView(
                  message: l10n.noDataAvailable, // متن ترجمه شد
                  onRetry: () => context.read<MarketDataBloc>().add(FetchMarketDataEvent()),
                );
              }
              
              return RefreshIndicator(
                onRefresh: () async {
                  context.read<MarketDataBloc>().add(FetchMarketDataEvent());
                },
                child: CustomScrollView(
                  slivers: [
                    HomeHeader(onSearchTapped: () => context.go(AppRoutes.search)),
                    SliverList(
                      delegate: SliverChildListDelegate([
                        const SizedBox(height: 24),
                        CategoryListView(categories: marketData.categories),
                        SectionDivider(title: l10n.specialOffers), // متن ترجمه شد
                        // ۴. استفاده از ویجت بنر شما
                        const BannerCarouselView(
                          bannerImageUrls: [
                            'assets/images/banner1.png',
                            'assets/images/banner2.png',
                            'assets/images/banner3.png',
                          ],
                        ),
                        SectionDivider(title: l10n.affordableProducts), // متن ترجمه شد
                        // ۵. استفاده از ویجت محصولات شما
                        AffordableProductsSection(
                          products: marketData.products,
                          stores: marketData.stores,
                        ),
                        SectionDivider(title: l10n.stores), // متن ترجمه شد
                        StoresByCitySection(stores: marketData.stores),
                        const SizedBox(height: 50),
                      ]),
                    ),
                  ],
                ),
              );
            }
            return const SizedBox.shrink();
          },
        ),
      ),
    );
  }
}

// این ویجت از کد قبلی شما حفظ شده و اکنون چندزبانه است
class _InitialLoadingView extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(),
          const SizedBox(height: 24),
          Text(
            l10n.connectingToServer, // متن ترجمه شد
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 8),
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 32.0),
            child: Text(
              l10n.initialLoadingMessage, // متن ترجمه شد
              textAlign: TextAlign.center,
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(color: Colors.grey.shade600),
            ),
          ),
        ],
      ),
    );
  }
}

====================
فایل: main_tab_bar_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\view\main_tab_bar_view.dart
====================

// مسیر: lib/features/home/presentation/view/main_tab_bar_view.dart

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
// ۱. این import برای دسترسی به ترجمه‌ها ضروری است
import 'package:persia_markt/l10n/app_localizations.dart';

class MainTabBarView extends StatelessWidget {
  final StatefulNavigationShell navigationShell;
  const MainTabBarView({
    super.key,
    required this.navigationShell,
  });

  @override
  Widget build(BuildContext context) {
    // ۲. نمونه l10n برای استفاده در ویجت ساخته می‌شود
    final l10n = AppLocalizations.of(context)!;

    // Directionality برای پشتیبانی صحیح از زبان فارسی اضافه شد
    return Directionality(
      textDirection: l10n.localeName == 'fa' ? TextDirection.rtl : TextDirection.ltr,
      child: Scaffold(
        body: navigationShell,
        bottomNavigationBar: BottomNavigationBar(
          currentIndex: navigationShell.currentIndex,
          onTap: (index) {
            navigationShell.goBranch(
              index,
              initialLocation: index == navigationShell.currentIndex,
            );
          },
          type: BottomNavigationBarType.fixed, // برای نمایش صحیح همه لیبل‌ها
          items: [
            // ۳. تمام لیبل‌ها اکنون از l10n خوانده می‌شوند
            BottomNavigationBarItem(
                icon: const Icon(Icons.home_outlined),
                activeIcon: const Icon(Icons.home),
                label: l10n.home),
            BottomNavigationBarItem(
                icon: const Icon(Icons.map_outlined),
                activeIcon: const Icon(Icons.map),
                label: l10n.map),
            BottomNavigationBarItem(
                icon: const Icon(Icons.favorite_border),
                activeIcon: const Icon(Icons.favorite),
                label: l10n.favorites),
            BottomNavigationBarItem(
                icon: const Icon(Icons.person_outline),
                activeIcon: const Icon(Icons.person),
                label: l10n.profile),
          ],
        ),
      ),
    );
  }
}

====================
فایل: affordable_products_section.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\widgets\affordable_products_section.dart
====================

import 'package:flutter/material.dart';
import 'package:persia_markt/core/models/category_item.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/models/store.dart';
import 'package:persia_markt/core/widgets/product_card_view.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';

class AffordableProductsSection extends StatelessWidget {
  final List<Product> products;
  final List<Store> stores;
  
  // Constructor was missing, added it back.
  const AffordableProductsSection({super.key, required this.products, required this.stores});

  @override
  Widget build(BuildContext context) {
    // --- FIXED: Dynamically find the "Economical" category ID ---
    final marketState = context.read<MarketDataBloc>().state;
    String? affordableCategoryId;

    if (marketState is MarketDataLoaded) {
      try {
        // Find the category by its Persian name.
        final affordableCategory = marketState.marketData.categories.firstWhere(
          (c) => c.name == 'اقتصادی',
        );
        affordableCategoryId = affordableCategory.id;
      } catch (e) {
        // If the category doesn't exist, do nothing.
        print('"اقتصادی" category not found.');
      }
    }

    // If the category ID couldn't be found, don't show the section.
    if (affordableCategoryId == null) {
      return const SizedBox.shrink();
    }

    // Filter products that belong to the dynamically found category ID.
    final affordableProducts = products.where((p) => p.categoryID == affordableCategoryId).toList();
    
    if (affordableProducts.isEmpty) {
      return const SizedBox.shrink(); // Return empty space if no affordable products
    }

    return SizedBox(
      height: 250, // Height for ProductCardView
      child: ListView.builder(
        scrollDirection: Axis.horizontal,
        itemCount: affordableProducts.length,
        padding: const EdgeInsets.symmetric(horizontal: 8),
        itemBuilder: (context, index) {
          final product = affordableProducts[index];
          // Safely find the corresponding store.
          final store = stores.firstWhere(
            (s) => s.storeID == product.storeID,
            orElse: () => Store.empty(), // Return a dummy store if not found
          );
          if (store.storeID.isEmpty) return const SizedBox.shrink();
          
          return ProductCardView(product: product, store: store);
        },
      ),
    );
  }
}


====================
فایل: banner_carousel_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\widgets\banner_carousel_view.dart
====================

// lib/features/home/presentation/widgets/banner_carousel_view.dart
import 'package:flutter/material.dart';
import 'dart:async';

class BannerCarouselView extends StatefulWidget {
  final List<String> bannerImageUrls;
  const BannerCarouselView({super.key, required this.bannerImageUrls});

  @override
  State<BannerCarouselView> createState() => _BannerCarouselViewState();
}

class _BannerCarouselViewState extends State<BannerCarouselView> {
  late final PageController _pageController;
  late final Timer _timer;
  int _currentPage = 0;

  @override
  void initState() {
    super.initState();
    _pageController = PageController(viewportFraction: 0.9);
    _startAutoScroll();
  }

  void _startAutoScroll() {
    _timer = Timer.periodic(const Duration(seconds: 4), (timer) {
      if (_pageController.hasClients) {
        _currentPage = (_currentPage + 1) % widget.bannerImageUrls.length;
        _pageController.animateToPage(
          _currentPage,
          duration: const Duration(milliseconds: 600),
          curve: Curves.easeInOutCubic,
        );
      }
    });
  }

  @override
  void dispose() {
    _timer.cancel();
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 150,
      child: PageView.builder(
        controller: _pageController,
        itemCount: widget.bannerImageUrls.length,
        itemBuilder: (context, index) {
          return Container(
            margin: const EdgeInsets.symmetric(horizontal: 8),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              image: DecorationImage(
                image: AssetImage(widget.bannerImageUrls[index]),
                fit: BoxFit.cover,
              ),
            ),
          );
        },
      ),
    );
  }
}

====================
فایل: category_list_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\widgets\category_list_view.dart
====================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/config/app_routes.dart';
import 'package:persia_markt/core/models/category_item.dart';
// ۱. پکیج انیمیشن را ایمپورت کنید
import 'package:flutter_staggered_animations/flutter_staggered_animations.dart';

class CategoryListView extends StatelessWidget {
  final List<CategoryItem> categories;
  const CategoryListView({super.key, required this.categories});

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 120,
      // ۲. ListView.builder را با AnimationLimiter بپوشانید
      child: AnimationLimiter(
        child: ListView.builder(
          scrollDirection: Axis.horizontal,
          itemCount: categories.length,
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
          itemBuilder: (context, index) {
            final category = categories[index];
            // ۳. هر آیتم را با کامپوننت‌های انیمیشن بپوشانید
            return AnimationConfiguration.staggeredList(
              position: index,
              duration: const Duration(milliseconds: 375),
              child: SlideAnimation(
                verticalOffset: 50.0,
                child: FadeInAnimation(
                  child: GestureDetector(
                    onTap: () => context.go(AppRoutes.categoryDetailPath(category.id)),
                    child: Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 8.0),
                      child: Column(
                        children: [
                          Container(
                            width: 80,
                            height: 80,
                            decoration: BoxDecoration(
                              color: Theme.of(context).cardColor,
                              shape: BoxShape.circle,
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withAlpha((255 * 0.1).round()),
                                  blurRadius: 8.0,
                                  spreadRadius: 2.0,
                                  offset: const Offset(0, 4),
                                ),
                              ],
                            ),
                            child: ClipOval(
                              child: (category.iconUrl != null && category.iconUrl!.isNotEmpty)
                                  ? Image.network(
                                      category.iconUrl!,
                                      fit: BoxFit.cover,
                                      errorBuilder: (context, error, stackTrace) => _buildPlaceholderIcon(),
                                      loadingBuilder: (context, child, loadingProgress) {
                                        if (loadingProgress == null) return child;
                                        return const Center(
                                          child: CircularProgressIndicator(strokeWidth: 2.0),
                                        );
                                      },
                                    )
                                  : _buildPlaceholderIcon(),
                            ),
                          ),
                          const SizedBox(height: 8),
                          Text(
                            category.name,
                            style: Theme.of(context).textTheme.bodyMedium?.copyWith(fontWeight: FontWeight.bold),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            );
          },
        ),
      ),
    );
  }

  Widget _buildPlaceholderIcon() {
    return Padding(
      padding: const EdgeInsets.all(12.0),
      child: Image.asset(
        'assets/images/supermarket.png',
        color: Colors.grey.shade400,
      ),
    );
  }
}

====================
فایل: home_header.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\widgets\home_header.dart
====================

import 'package:flutter/material.dart'; // <<<--- مشکل اصلی اینجا بود و برطرف شد
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:persia_markt/features/home/presentation/cubit/location_cubit.dart';
import 'package:persia_markt/features/home/presentation/cubit/location_state.dart';
import 'package:persia_markt/l10n/app_localizations.dart';

class HomeHeader extends StatelessWidget {
  final VoidCallback onSearchTapped;
  const HomeHeader({super.key, required this.onSearchTapped});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;

    return SliverAppBar(
      pinned: true,
      floating: true,
      expandedHeight: 180,
      backgroundColor: Colors.transparent,
      flexibleSpace: FlexibleSpaceBar(
        background: Container(
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: [Colors.orange.shade400, Colors.orange.shade100],
            ),
          ),
          child: SafeArea(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Image.asset('assets/images/appLogo.png', height: 40),
                      const SizedBox(width: 8),
                      Text(
                        l10n.persiaMarkt,
                        style: GoogleFonts.inter(fontSize: 24, fontWeight: FontWeight.w900, color: Colors.white),
                      ),
                      const Spacer(),
                      BlocBuilder<LocationCubit, LocationState>(
                        builder: (context, state) {
                          String locationText = l10n.gettingLocation;
                          if (state is LocationLoaded) {
                            locationText = state.address;
                          } else if (state is LocationError) {
                            locationText = l10n.locationUnknown;
                          }
                          return Column(
                            crossAxisAlignment: CrossAxisAlignment.end,
                            children: [
                              Text(l10n.yourLocation, style: const TextStyle(color: Colors.white70, fontSize: 10)),
                              Text(locationText, style: const TextStyle(color: Colors.white, fontSize: 14)),
                            ],
                          );
                        },
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  GestureDetector(
                    onTap: onSearchTapped,
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                      decoration: BoxDecoration(
                        color: Theme.of(context).cardColor,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Row(
                        children: [
                          Icon(Icons.search, color: Colors.grey.shade500),
                          const SizedBox(width: 8),
                          Text(l10n.searchHint, style: TextStyle(color: Colors.grey.shade500)),
                        ],
                      ),
                    ),
                  )
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

====================
فایل: home_loading_shimmer.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\widgets\home_loading_shimmer.dart
====================

// lib/features/home/presentation/widgets/home_loading_shimmer.dart
import 'package:flutter/material.dart';
import 'package:persia_markt/core/widgets/loading_shimmer.dart';

class HomeLoadingShimmer extends StatelessWidget {
  const HomeLoadingShimmer({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      physics: const NeverScrollableScrollPhysics(),
      child: Column(
        children: [
          // Header Shimmer
          const ShimmerBox(width: double.infinity, height: 180, shape: RoundedRectangleBorder(borderRadius: BorderRadius.zero)),
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const SizedBox(height: 24),
                const ShimmerBox(width: 150, height: 24),
                const SizedBox(height: 16),
                SizedBox(
                  height: 120,
                  child: ListView.builder(
                    scrollDirection: Axis.horizontal,
                    itemCount: 5,
                    itemBuilder: (context, index) => const Padding(
                      padding: EdgeInsets.symmetric(horizontal: 8.0),
                      child: Column(
                        children: [
                          ShimmerBox(width: 80, height: 80, shape: CircleBorder()),
                          SizedBox(height: 8),
                          ShimmerBox(width: 60, height: 16),
                        ],
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 24),
                const ShimmerBox(width: 150, height: 24),
                const SizedBox(height: 16),
                const ShimmerBox(width: double.infinity, height: 150),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

====================
فایل: section_divider.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\widgets\section_divider.dart
====================

// lib/features/home/presentation/widgets/section_divider.dart
import 'package:flutter/material.dart';

class SectionDivider extends StatelessWidget {
  final String title;
  const SectionDivider({Key? key, required this.title}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 24.0, horizontal: 16),
      child: Row(
        children: [
          Expanded(child: Divider(thickness: 0.5, color: Colors.grey.shade400)),
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16.0),
            child: Text(
              title,
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.bold,
                    color: Colors.grey.shade700,
                  ),
            ),
          ),
          Expanded(child: Divider(thickness: 0.5, color: Colors.grey.shade400)),
        ],
      ),
    );
  }
}

====================
فایل: stores_by_city_section.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\home\presentation\widgets\stores_by_city_section.dart
====================

import 'package:flutter/material.dart';
import 'package:persia_markt/core/models/store.dart';
import 'package:persia_markt/core/widgets/store_list_item_view.dart';

class StoresByCitySection extends StatelessWidget {
  final List<Store> stores;
  const StoresByCitySection({super.key, required this.stores});

  @override
  Widget build(BuildContext context) {
    final Map<String, List<Store>> storesByCity = {};
    for (var store in stores) {
      if (store.city != null && store.city!.isNotEmpty) {
        storesByCity.putIfAbsent(store.city!, () => []).add(store);
      }
    }

    if (storesByCity.isEmpty) return const SizedBox.shrink();

    // استفاده از LayoutBuilder برای تشخیص اندازه صفحه
    return LayoutBuilder(
      builder: (context, constraints) {
        // اگر عرض صفحه بیشتر از ۶۰۰ پیکسل باشد، از گرید استفاده کن
        final bool isWideScreen = constraints.maxWidth > 600;

        return ListView.builder(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          itemCount: storesByCity.keys.length,
          itemBuilder: (context, index) {
            final city = storesByCity.keys.elementAt(index);
            final cityStores = storesByCity[city]!;
            return Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Padding(
                  padding: const EdgeInsets.fromLTRB(16, 16, 16, 8),
                  child: Text(city, style: Theme.of(context).textTheme.headlineSmall),
                ),
                // بر اساس عرض صفحه، ویجت مناسب را نمایش بده
                isWideScreen
                    ? _buildStoresGrid(cityStores)
                    : _buildStoresList(cityStores),
              ],
            );
          },
        );
      },
    );
  }

  // ویجت برای نمایش لیست عمودی (موبایل)
  Widget _buildStoresList(List<Store> stores) {
    return Column(
      children: stores.map((store) => StoreListItemView(store: store)).toList(),
    );
  }

  // ویجت جدید برای نمایش گرید (تبلت)
  Widget _buildStoresGrid(List<Store> stores) {
    return GridView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      padding: const EdgeInsets.symmetric(horizontal: 16),
      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 2, // دو ستون
        crossAxisSpacing: 12,
        mainAxisSpacing: 12,
        childAspectRatio: 3.5, // نسبت عرض به ارتفاع هر آیتم
      ),
      itemCount: stores.length,
      itemBuilder: (context, index) {
        // در گرید، margin آیتم‌ها را حذف می‌کنیم تا بهتر نمایش داده شوند
        return StoreListItemView(
          store: stores[index],
          // Note: To make this work perfectly, you might need to adjust StoreListItemView 
          // to accept an optional margin parameter and set it to EdgeInsets.zero here.
        );
      },
    );
  }
}

====================
فایل: map_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\map\view\map_view.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_map/flutter_map.dart';
import 'package:latlong2/latlong.dart';
import 'package:persia_markt/core/models/store.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';
import 'package:persia_markt/features/home/presentation/cubit/location_cubit.dart';
import 'package:persia_markt/features/home/presentation/cubit/location_state.dart';
import 'package:persia_markt/l10n/app_localizations.dart'; // ۱. Import برای ترجمه

class MapView extends StatefulWidget {
  final String? lat;
  final String? lng;
  final String? focus;

  const MapView({super.key, this.lat, this.lng, this.focus});

  @override
  State<MapView> createState() => _MapViewState();
}

class _MapViewState extends State<MapView> {
  late final MapController _mapController;
  bool _hasFocused = false;

  @override
  void initState() {
    super.initState();
    _mapController = MapController();
  }

  @override
  void dispose() {
    _mapController.dispose();
    super.dispose();
  }

  void _tryFocusStore(List<Store> stores) {
    if (_hasFocused) return;
    if (widget.focus != null && widget.focus!.isNotEmpty) {
      final store = stores.firstWhere(
        (s) => s.storeID == widget.focus,
        orElse: () => Store.empty(),
      );
      if (store.storeID.isNotEmpty) {
        _mapController.move(LatLng(store.latitude, store.longitude), 17.0);
        _hasFocused = true;
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!; // ۲. نمونه l10n
    LatLng initialCenter = const LatLng(51.1657, 10.4515);
    double initialZoom = 6.0;

    if (widget.lat != null && widget.lng != null) {
      final lat = double.tryParse(widget.lat!);
      final lng = double.tryParse(widget.lng!);
      if (lat != null && lng != null) {
        initialCenter = LatLng(lat, lng);
        initialZoom = 15.0;
      }
    }

    return Scaffold(
      appBar: AppBar(
        // ۳. عنوان AppBar ترجمه شد
        title: Text(l10n.map),
      ),
      body: BlocBuilder<MarketDataBloc, MarketDataState>(
        builder: (context, marketState) {
          if (marketState is! MarketDataLoaded) {
            return const Center(child: CircularProgressIndicator());
          }

          final stores = marketState.marketData.stores;

          WidgetsBinding.instance.addPostFrameCallback((_) {
            _tryFocusStore(stores);
          });

          return FlutterMap(
            mapController: _mapController,
            options: MapOptions(
              initialCenter: initialCenter,
              initialZoom: initialZoom,
              onMapReady: () => _tryFocusStore(stores),
            ),
            children: [
              TileLayer(
                urlTemplate: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                subdomains: const ['a', 'b', 'c'],
              ),
              _buildStoreMarkers(stores),
              _buildUserLocationMarker(context),
            ],
          );
        },
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          final locationState = context.read<LocationCubit>().state;
          if (locationState is LocationLoaded) {
            _mapController.move(
              LatLng(locationState.position.latitude, locationState.position.longitude),
              15.0,
            );
          }
        },
        // ۴. لیبل دکمه ترجمه شد
        label: Text(l10n.myLocation),
        icon: const Icon(Icons.my_location),
      ),
    );
  }

  Widget _buildStoreMarkers(List<Store> stores) {
    return MarkerLayer(
      markers: stores.map((s) {
        return Marker(
          point: LatLng(s.latitude, s.longitude),
          width: 40,
          height: 40,
          child: Tooltip(
            message: s.name,
            child: GestureDetector(
              onTap: () {
                _mapController.move(LatLng(s.latitude, s.longitude), 17.0);
              },
              child: const Icon(Icons.location_on, size: 36, color: Colors.orange),
            ),
          ),
        );
      }).toList(),
    );
  }

  Widget _buildUserLocationMarker(BuildContext context) {
    final loc = context.watch<LocationCubit>().state;
    if (loc is! LocationLoaded) return const SizedBox.shrink();

    return MarkerLayer(
      markers: [
        Marker(
          point: LatLng(loc.position.latitude, loc.position.longitude),
          width: 36,
          height: 36,
          child: const Icon(Icons.my_location, size: 28, color: Colors.blue),
        ),
      ],
    );
  }
}

====================
فایل: favorites_cubit.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\profile\presentation\cubit\favorites_cubit.dart
====================

// lib/features/profile/presentation/cubit/favorites_cubit.dart
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'favorites_state.dart';

/// Manages the state of the user's favorite products.
/// It uses SharedPreferences for persistence.
class FavoritesCubit extends Cubit<FavoritesState> {
  final SharedPreferences _sharedPreferences;
  static const _key = 'likedProducts';

  FavoritesCubit({required SharedPreferences sharedPreferences})
      : _sharedPreferences = sharedPreferences,
        super(const FavoritesState(productIds: []));

  /// Loads the list of liked product IDs from local storage.
  void loadLikedProducts() {
    final likedIds = _sharedPreferences.getStringList(_key) ?? [];
    emit(FavoritesState(productIds: likedIds));
  }

  /// Toggles the like status of a product and saves it to local storage.
  Future<void> toggleLike(String productId) async {
    final currentIds = List<String>.from(state.productIds);
    if (currentIds.contains(productId)) {
      currentIds.remove(productId);
    } else {
      currentIds.add(productId);
    }
    await _sharedPreferences.setStringList(_key, currentIds);
    emit(FavoritesState(productIds: currentIds));
  }
}

====================
فایل: favorites_state.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\profile\presentation\cubit\favorites_state.dart
====================

// lib/features/profile/presentation/cubit/favorites_state.dart
import 'package:equatable/equatable.dart';

/// The state for the FavoritesCubit, containing the list of favorite product IDs.
class FavoritesState extends Equatable {
  final List<String> productIds;
  const FavoritesState({required this.productIds});

  @override
  List<Object> get props => [productIds];
}

====================
فایل: favorites_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\profile\presentation\view\favorites_view.dart
====================

// lib/features/profile/presentation/view/favorites_view.dart
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/widgets/product_list_item_view.dart';
// اصلاح شد: 'packagepackage:' به 'package:' تغییر یافت.
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';
import 'package:persia_markt/features/profile/presentation/cubit/favorites_cubit.dart';
import 'package:persia_markt/features/profile/presentation/cubit/favorites_state.dart';

class FavoritesView extends StatelessWidget {
  const FavoritesView({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('سبد خرید شما')),
      body: BlocBuilder<MarketDataBloc, MarketDataState>(
        builder: (context, marketState) {
          if (marketState is MarketDataLoaded) {
            return BlocBuilder<FavoritesCubit, FavoritesState>(
              builder: (context, favoritesState) {
                final favoriteProducts = marketState.marketData.products
                    .where((p) => favoritesState.productIds.contains(p.id))
                    .toList();
                
                if (favoriteProducts.isEmpty) {
                  return const Center(child: Text('سبد خرید شما خالی است.'));
                }

                // اصلاح شده: گروه‌بندی محصولات بر اساس فروشگاه
                final Map<String, List<Product>> productsByStore = {};
                for (var product in favoriteProducts) {
                  productsByStore.putIfAbsent(product.storeID, () => []).add(product);
                }
                
                final double grandTotal = favoriteProducts.fold(0, (sum, item) => sum + item.price);

                return Column(
                  children: [
                    // اصلاح شده: بنر تبلیغاتی
                    Container(
                      height: 100,
                      margin: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(12),
                        image: const DecorationImage(
                          image: AssetImage('assets/images/banner4.png'),
                          fit: BoxFit.cover,
                        ),
                      ),
                    ),
                    Expanded(
                      child: ListView.builder(
                        itemCount: productsByStore.keys.length,
                        itemBuilder: (context, index) {
                          final storeId = productsByStore.keys.elementAt(index);
                          final store = marketState.marketData.stores.firstWhere((s) => s.storeID == storeId);
                          final productsInStore = productsByStore[storeId]!;
                          final double storeSubtotal = productsInStore.fold(0, (sum, item) => sum + item.price);

                          return Card(
                            margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Padding(
                                  padding: const EdgeInsets.all(12.0),
                                  child: Text(store.name, style: Theme.of(context).textTheme.titleLarge),
                                ),
                                const Divider(height: 1),
                                ...productsInStore.map((p) => ProductListItemView(product: p, store: store)),
                                // نمایش مجموع قیمت هر فروشگاه
                                Padding(
                                  padding: const EdgeInsets.all(12.0),
                                  child: Align(
                                    alignment: Alignment.centerLeft,
                                    child: Text(
                                      'جمع: €${storeSubtotal.toStringAsFixed(2)}',
                                      style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          );
                        },
                      ),
                    ),
                    // نمایش مجموع کل
                    Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Text(
                        'مجموع کل: €${grandTotal.toStringAsFixed(2)}',
                        style: Theme.of(context).textTheme.headlineSmall?.copyWith(fontWeight: FontWeight.bold),
                      ),
                    ),
                    // اصلاح شده: کادر نهایی
                    Container(
                      width: double.infinity,
                      margin: const EdgeInsets.fromLTRB(16, 0, 16, 16),
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.green.shade50,
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: Colors.green.shade300),
                      ),
                      child: const Text(
                        'به زودی قابلیت ارسال سفارش به این اپلیکیشن اضافه خواهد شد.',
                        textAlign: TextAlign.center,
                        style: TextStyle(color: Colors.black87),
                      ),
                    ),
                  ],
                );
              },
            );
          }
          return const Center(child: CircularProgressIndicator());
        },
      ),
    );
  }
}

====================
فایل: profile_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\profile\presentation\view\profile_view.dart
====================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/core/cubit/locale_cubit.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_cubit.dart';
import 'package:persia_markt/features/auth/presentation/cubit/auth_state.dart';
import 'package:jwt_decoder/jwt_decoder.dart';
import 'package:persia_markt/l10n/app_localizations.dart';

class ProfileView extends StatelessWidget {
  const ProfileView({super.key});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;

    return Scaffold(
      appBar: AppBar(
        title: Text(l10n.myProfile),
        actions: [
          BlocBuilder<AuthCubit, AuthState>(
            builder: (context, state) {
              if (state is Authenticated) {
                return IconButton(
                  icon: const Icon(Icons.logout),
                  tooltip: l10n.logout,
                  onPressed: () {
                    showDialog(
                      context: context,
                      builder: (dialogContext) => AlertDialog(
                        title: Text(l10n.logoutFromAccount),
                        content: Text(l10n.logoutConfirmation),
                        actions: [
                          TextButton(
                            onPressed: () => Navigator.of(dialogContext).pop(),
                            child: Text(l10n.cancel),
                          ),
                          TextButton(
                            onPressed: () {
                              context.read<AuthCubit>().logoutUser();
                              Navigator.of(dialogContext).pop();
                            },
                            child: Text(l10n.logout),
                          ),
                        ],
                      ),
                    );
                  },
                );
              }
              return const SizedBox.shrink();
            },
          )
        ],
      ),
      body: BlocBuilder<AuthCubit, AuthState>(
        builder: (context, state) {
          if (state is Authenticated) {
            return _buildProfileInfo(context);
          }
          return Center(
            child: Text(l10n.loginToSeeProfile),
          );
        },
      ),
    );
  }

  Widget _buildProfileInfo(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    Map<String, dynamic> userInfo = {};

    // no token in Authenticated -> just leave it empty for now
    const String token = "";

    try {
      userInfo = JwtDecoder.decode(token);
    } catch (_) {}

    final String name = userInfo['name'] ?? l10n.guestUser;
    final String email = userInfo['email'] ?? l10n.unknownEmail;

    return ListView(
      padding: const EdgeInsets.all(16.0),
      children: [
        CircleAvatar(
          radius: 50,
          child: Text(
            name.isNotEmpty ? name[0].toUpperCase() : 'P',
            style: Theme.of(context).textTheme.headlineLarge,
          ),
        ),
        const SizedBox(height: 16),
        Center(
          child: Text(
            name,
            style: Theme.of(context).textTheme.headlineSmall,
          ),
        ),
        const SizedBox(height: 8),
        Center(
          child: Text(
            email,
            style: Theme.of(context).textTheme.bodyLarge?.copyWith(color: Colors.grey),
          ),
        ),
        const Divider(height: 40),
        ListTile(
          leading: const Icon(Icons.language_outlined),
          title: Text(l10n.changeLanguage),
          onTap: () => _showLanguageDialog(context),
        ),
        ListTile(
          leading: const Icon(Icons.settings_outlined),
          title: Text(l10n.accountSettings),
          onTap: () {},
        ),
        ListTile(
          leading: const Icon(Icons.history_outlined),
          title: Text(l10n.orderHistory),
          onTap: () {},
        ),
      ],
    );
  }

  void _showLanguageDialog(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    showDialog(
      context: context,
      builder: (BuildContext dialogContext) {
        return SimpleDialog(
          title: Text(l10n.selectLanguage),
          children: <Widget>[
            SimpleDialogOption(
              onPressed: () {
                context.read<LocaleCubit>().changeLocale('fa');
                Navigator.pop(dialogContext);
              },
              child: Text(l10n.persian),
            ),
            SimpleDialogOption(
              onPressed: () {
                context.read<LocaleCubit>().changeLocale('en');
                Navigator.pop(dialogContext);
              },
              child: Text(l10n.english),
            ),
            SimpleDialogOption(
              onPressed: () {
                context.read<LocaleCubit>().changeLocale('de');
                Navigator.pop(dialogContext);
              },
              child: Text(l10n.german),
            ),
          ],
        );
      },
    );
  }
}


====================
فایل: search_cubit.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\search\presentation\cubit\search_cubit.dart
====================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/models/store.dart';
import 'search_state.dart';

/// Manages the business logic for the search feature.
class SearchCubit extends Cubit<SearchState> {
  SearchCubit() : super(SearchInitial());

  /// Performs a search based on a query against all products and stores.
  void performSearch({
    required String query,
    required List<Product> allProducts,
    required List<Store> allStores,
  }) {
    if (query.isEmpty) {
      emit(SearchInitial());
      return;
    }

    emit(SearchLoading());

    final lowerCaseQuery = query.toLowerCase();

    // Filter products based on name and description.
    final productResults = allProducts
        .where((p) =>
            p.name.toLowerCase().contains(lowerCaseQuery) ||
            p.description.toLowerCase().contains(lowerCaseQuery))
        .toList();

    // Filter stores based on name, address, and city.
    final storeResults = allStores
        .where((s) {
          final nameMatch = s.name.toLowerCase().contains(lowerCaseQuery);
          final addressMatch = s.address.toLowerCase().contains(lowerCaseQuery);
          // FIXED: Safely handle nullable city by using a null-aware check.
          final cityMatch = s.city?.toLowerCase().contains(lowerCaseQuery) ?? false;
          return nameMatch || addressMatch || cityMatch;
        })
        .toList();

    emit(SearchLoaded(
      filteredProducts: productResults,
      filteredStores: storeResults,
      query: query,
    ));
  }

  /// Resets the search state to its initial value.
  void clearSearch() {
    emit(SearchInitial());
  }
}


====================
فایل: search_state.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\search\presentation\cubit\search_state.dart
====================

// lib/features/search/presentation/cubit/search_state.dart
import 'package:equatable/equatable.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/models/store.dart';

/// Base class for all states related to the search feature.
abstract class SearchState extends Equatable {
  const SearchState();
  @override
  List<Object> get props => [];
}

/// The initial state before any search query is entered.
class SearchInitial extends SearchState {}

/// The state indicating that a search is in progress.
class SearchLoading extends SearchState {}

/// The state representing successfully loaded search results.
class SearchLoaded extends SearchState {
  final List<Product> filteredProducts;
  final List<Store> filteredStores;
  final String query;

  const SearchLoaded({
    required this.filteredProducts,
    required this.filteredStores,
    required this.query,
  });

  @override
  List<Object> get props => [filteredProducts, filteredStores, query];
}

====================
فایل: search_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\search\presentation\view\search_view.dart
====================

import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/widgets/product_list_item_view.dart';
import 'package:persia_markt/core/widgets/store_list_item_view.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';
import 'package:persia_markt/features/search/presentation/cubit/search_cubit.dart';
import 'package:persia_markt/features/search/presentation/cubit/search_state.dart';

class SearchView extends StatefulWidget {
  const SearchView({super.key});

  @override
  State<SearchView> createState() => _SearchViewState();
}

class _SearchViewState extends State<SearchView> with SingleTickerProviderStateMixin {
  late final TextEditingController _searchController;
  late final TabController _tabController;
  Timer? _debounce;

  @override
  void initState() {
    super.initState();
    _searchController = TextEditingController();
    _tabController = TabController(length: 2, vsync: this);
  }

  @override
  void dispose() {
    _debounce?.cancel();
    _searchController.dispose();
    _tabController.dispose();
    super.dispose();
  }

  void _onChanged(String text, MarketDataState marketState) {
    if (_debounce?.isActive ?? false) _debounce?.cancel();
    _debounce = Timer(const Duration(milliseconds: 300), () {
      if (marketState is MarketDataLoaded) {
        context.read<SearchCubit>().performSearch(
          query: text,
          allProducts: marketState.marketData.products,
          allStores: marketState.marketData.stores,
        );
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<MarketDataBloc, MarketDataState>(
      builder: (context, marketState) {
        return Scaffold(
          appBar: AppBar(
            title: TextField(
              controller: _searchController,
              autofocus: true,
              decoration: const InputDecoration(
                hintText: 'جستجو در محصولات و فروشگاه‌ها...',
                border: InputBorder.none,
              ),
              onChanged: (t) => _onChanged(t, marketState),
            ),
            bottom: TabBar(
              controller: _tabController,
              tabs: const [
                Tab(text: 'محصولات'),
                Tab(text: 'فروشگاه‌ها'),
              ],
            ),
          ),
          body: BlocBuilder<SearchCubit, SearchState>(
            builder: (context, searchState) {
              if (searchState is SearchInitial) {
                return const Center(child: Text('لطفاً عبارت مورد نظر را وارد کنید.'));
              }
              if (searchState is SearchLoading) {
                return const Center(child: CircularProgressIndicator());
              }
              if (searchState is SearchLoaded) {
                if (searchState.filteredProducts.isEmpty && searchState.filteredStores.isEmpty) {
                  return const Center(child: Text('نتیجه‌ای یافت نشد.'));
                }

                final Map<String, List<Product>> groupedProducts = {};
                for (var product in searchState.filteredProducts) {
                  groupedProducts.putIfAbsent(product.storeID, () => []).add(product);
                }
                final storeIds = groupedProducts.keys.toList();

                return TabBarView(
                  controller: _tabController,
                  children: [
                    // محصولات (گروه‌بندی‌شده بر اساس فروشگاه)
                    ListView.builder(
                      itemCount: storeIds.length,
                      itemBuilder: (context, index) {
                        if (marketState is! MarketDataLoaded) return const SizedBox.shrink();

                        final storeId = storeIds[index];
                        final productsInStore = groupedProducts[storeId]!;
                        final store = marketState.marketData.stores
                            .firstWhere((s) => s.storeID == storeId);

                        return Card(
                          margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Padding(
                                padding: const EdgeInsets.all(12.0),
                                child: Text(store.name, style: Theme.of(context).textTheme.titleLarge),
                              ),
                              const Divider(height: 1, indent: 12, endIndent: 12),
                              ListView.builder(
                                shrinkWrap: true,
                                physics: const NeverScrollableScrollPhysics(),
                                itemCount: productsInStore.length,
                                itemBuilder: (context, productIndex) {
                                  final product = productsInStore[productIndex];
                                  return ProductListItemView(product: product, store: store);
                                },
                              ),
                            ],
                          ),
                        );
                      },
                    ),
                    // فروشگاه‌ها
                    ListView.builder(
                      itemCount: searchState.filteredStores.length,
                      itemBuilder: (context, index) {
                        final store = searchState.filteredStores[index];
                        return StoreListItemView(store: store);
                      },
                    ),
                  ],
                );
              }
              return const SizedBox.shrink();
            },
          ),
        );
      },
    );
  }
}


====================
فایل: seller_panel_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\seller_panel\view\seller_panel_view.dart
====================

// مسیر: lib/features/seller_panel/view/seller_panel_view.dart

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart'; // ۱. پکیج GoRouter برای بازگشت امن اضافه شد
import 'package:webview_flutter/webview_flutter.dart';
// ۲. مسیر import فایل ترجمه به مسیر صحیح و استاندارد تغییر یافت
import 'package:persia_markt/l10n/app_localizations.dart';

class SellerPanelView extends StatefulWidget {
  const SellerPanelView({super.key});

  @override
  State<SellerPanelView> createState() => _SellerPanelViewState();
}

class _SellerPanelViewState extends State<SellerPanelView> {
  late final WebViewController _controller;
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _controller = WebViewController()
      ..setJavaScriptMode(JavaScriptMode.unrestricted)
      ..setBackgroundColor(const Color(0x00000000))
      ..setNavigationDelegate(
        NavigationDelegate(
          onPageStarted: (String url) {
            setState(() {
              _isLoading = true;
            });
          },
          onPageFinished: (String url) {
            setState(() {
              _isLoading = false;
            });
          },
          onWebResourceError: (WebResourceError error) {
            // شما می‌توانید در اینجا یک پیام خطا به کاربر نمایش دهید
          },
        ),
      )
      // آدرس پنل شما که ارسال کردید، اینجا استفاده شده است
      ..loadRequest(Uri.parse('https://persia-market-panel.vercel.app/'));
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    return Scaffold(
      appBar: AppBar(
        title: Text(l10n.sellerPanel),
        leading: IconButton(
          icon: const Icon(Icons.close),
          // ۳. دستور بازگشت برای سازگاری کامل با GoRouter اصلاح شد
          onPressed: () => context.pop(),
        ),
      ),
      body: Stack(
        children: [
          WebViewWidget(controller: _controller),
          if (_isLoading)
            const Center(
              child: CircularProgressIndicator(),
            ),
        ],
      ),
    );
  }
}

====================
فایل: store_detail_view.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\features\store\presentation\view\store_detail_view.dart
====================

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:persia_markt/core/models/category_item.dart';
import 'package:persia_markt/core/models/product.dart';
import 'package:persia_markt/core/models/store.dart';
import 'package:persia_markt/core/widgets/product_list_item_view.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';

class StoreDetailView extends StatefulWidget {
  final String storeId;
  final String? initialProductId;

  const StoreDetailView({
    super.key,
    required this.storeId,
    this.initialProductId,
  });

  @override
  State<StoreDetailView> createState() => _StoreDetailViewState();
}

class _StoreDetailViewState extends State<StoreDetailView> {
  final Map<String, GlobalKey> _categoryKeys = {};
  final ScrollController _pageScrollController = ScrollController();

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _pageScrollController.jumpTo(0.0);
      if (widget.initialProductId != null) {
        _scrollToInitialProduct();
      }
    });
  }

  @override
  void dispose() {
    _pageScrollController.dispose();
    super.dispose();
  }

  void _scrollToCategory(String categoryId) {
    final key = _categoryKeys[categoryId];
    if (key != null && key.currentContext != null) {
      Scrollable.ensureVisible(
        key.currentContext!,
        duration: const Duration(milliseconds: 450),
        curve: Curves.easeInOut,
        alignment: 0.08,
      );
    }
  }

  void _scrollToInitialProduct() {
    final marketState = context.read<MarketDataBloc>().state;
    if (marketState is MarketDataLoaded) {
      final product = marketState.marketData.products.firstWhere(
        (p) => p.id == widget.initialProductId,
        orElse: () => marketState.marketData.products.first,
      );
      _scrollToCategory(product.categoryID);
    }
  }

  void _showImageDialog(BuildContext context, String imageUrl) {
    showDialog(
      context: context,
      barrierColor: Colors.black.withOpacity(0.5),
      builder: (BuildContext context) {
        return BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 5.0, sigmaY: 5.0),
          child: Dialog(
            backgroundColor: Colors.transparent,
            insetPadding: const EdgeInsets.all(20),
            child: GestureDetector(
              onTap: () => Navigator.of(context).pop(),
              child: InteractiveViewer(
                child: Image.network(
                  imageUrl,
                  errorBuilder: (_, __, ___) =>
                      const Icon(Icons.broken_image, color: Colors.white, size: 48),
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<MarketDataBloc, MarketDataState>(
      builder: (context, state) {
        if (state is! MarketDataLoaded) {
          return const Scaffold(body: Center(child: CircularProgressIndicator()));
        }

        final store = state.marketData.stores
            .firstWhere((s) => s.storeID == widget.storeId, orElse: () => Store.empty());
        if (store.storeID.isEmpty) {
          return const Scaffold(body: Center(child: Text('Store not found.')));
        }

        final allProducts = state.marketData.products
            .where((p) => p.storeID == store.storeID)
            .toList();

        // فقط دسته‌هایی که در این فروشگاه محصول دارند
        final Set<String> categoryIdsInStore =
            allProducts.map((p) => p.categoryID).toSet();
        final categories = state.marketData.categories
            .where((c) => categoryIdsInStore.contains(c.id))
            .toList();

        // کلیدها را قبل از ساخت ویجت‌ها تضمین می‌کنیم
        for (final c in categories) {
          _categoryKeys.putIfAbsent(c.id, () => GlobalKey());
        }

        return Scaffold(
          body: CustomScrollView(
            controller: _pageScrollController,
            slivers: [
              // هدر فروشگاه
              SliverAppBar(
                pinned: true,
                expandedHeight: 140,
                elevation: 0,
                flexibleSpace: FlexibleSpaceBar(
                  titlePadding: const EdgeInsetsDirectional.only(start: 16, bottom: 12, end: 16),
                  title: Text(store.name, overflow: TextOverflow.ellipsis),
                ),
              ),

              SliverToBoxAdapter(child: _buildStoreHeader(context, store)),

              // نوار دسته‌بندی افقی (پین‌شونده)
              _buildCategoryHeader(context, categories),

              // لیست محصولات گروه‌بندی‌شده بر اساس دسته
              ..._buildProductSlivers(categories, allProducts, store),
            ],
          ),
        );
      },
    );
  }

  Widget _buildStoreHeader(BuildContext context, Store store) {
    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 16, 16, 0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            store.name,
            style: Theme.of(context)
                .textTheme
                .headlineMedium
                ?.copyWith(fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 8),
          Row(
            children: [
              Icon(Icons.location_on_outlined, size: 16, color: Colors.grey.shade700),
              const SizedBox(width: 4),
              Expanded(child: Text(store.address, style: const TextStyle(fontSize: 16))),
              IconButton(
                icon: Icon(Icons.map_outlined, color: Theme.of(context).colorScheme.primary),
                tooltip: 'نمایش در نقشه',
                // به‌جای فقط focus، lat/lng را هم پاس می‌دهیم تا حتماً فوکوس شود
                onPressed: () => context.go(
                  '/map?lat=${store.latitude}&lng=${store.longitude}&focus=${store.storeID}',
                ),
              ),
            ],
          ),
          Row(
            children: [
              Icon(Icons.star_border, size: 16, color: Colors.grey.shade700),
              const SizedBox(width: 4),
              Text('امتیاز: ${store.rating}', style: const TextStyle(fontSize: 16)),
            ],
          ),
        ],
      ),
    );
  }

  SliverPersistentHeader _buildCategoryHeader(
      BuildContext context, List<CategoryItem> categories) {
    return SliverPersistentHeader(
      pinned: true,
      delegate: _SliverAppBarDelegate(
        minHeight: 60.0,
        maxHeight: 60.0,
        child: Container(
          color: Theme.of(context).scaffoldBackgroundColor.withAlpha(240),
          child: ListView.builder(
            scrollDirection: Axis.horizontal,
            itemCount: categories.length,
            padding: const EdgeInsets.symmetric(horizontal: 12),
            itemBuilder: (context, index) => Padding(
              padding: const EdgeInsets.symmetric(horizontal: 4.0, vertical: 10),
              child: ElevatedButton(
                onPressed: () => _scrollToCategory(categories[index].id),
                child: Text(categories[index].name),
              ),
            ),
          ),
        ),
      ),
    );
  }

  List<Widget> _buildProductSlivers(
      List<CategoryItem> categories, List<Product> allProducts, Store store) {
    return categories.map((category) {
      final productsInCategory =
          allProducts.where((p) => p.categoryID == category.id).toList();

      return SliverList(
        delegate: SliverChildListDelegate([
          // سکشن‌هدری که کلید روی آن ست می‌شود تا ensureVisible کار کند
          Container(
            key: _categoryKeys[category.id],
            padding: const EdgeInsets.fromLTRB(16, 24, 16, 8),
            child: Text(
              category.name,
              style: Theme.of(context).textTheme.headlineSmall,
            ),
          ),
          const Divider(indent: 16, endIndent: 16, height: 1),
          ...productsInCategory.map(
            (product) => ProductListItemView(
              product: product,
              store: store,
              onImageTap: () => _showImageDialog(context, product.primaryImageUrl),
            ),
          ),
        ]),
      );
    }).toList();
  }
}

class _SliverAppBarDelegate extends SliverPersistentHeaderDelegate {
  final double minHeight;
  final double maxHeight;
  final Widget child;

  _SliverAppBarDelegate({
    required this.minHeight,
    required this.maxHeight,
    required this.child,
  });

  @override
  double get minExtent => minHeight;
  @override
  double get maxExtent => maxHeight;

  @override
  Widget build(BuildContext context, double shrinkOffset, bool overlapsContent) {
    return SizedBox.expand(child: child);
  }

  @override
  bool shouldRebuild(_SliverAppBarDelegate oldDelegate) {
    return maxHeight != oldDelegate.maxHeight ||
        minHeight != oldDelegate.minHeight ||
        child != oldDelegate.child;
  }
}


====================
فایل: app_localizations.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\l10n\app_localizations.dart
====================

import 'dart:async';

import 'package:flutter/foundation.dart';
import 'package:flutter/widgets.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:intl/intl.dart' as intl;

import 'app_localizations_de.dart';
import 'app_localizations_en.dart';
import 'app_localizations_fa.dart';

// ignore_for_file: type=lint

/// Callers can lookup localized strings with an instance of AppLocalizations
/// returned by `AppLocalizations.of(context)`.
///
/// Applications need to include `AppLocalizations.delegate()` in their app's
/// `localizationDelegates` list, and the locales they support in the app's
/// `supportedLocales` list. For example:
///
/// ```dart
/// import 'l10n/app_localizations.dart';
///
/// return MaterialApp(
///   localizationsDelegates: AppLocalizations.localizationsDelegates,
///   supportedLocales: AppLocalizations.supportedLocales,
///   home: MyApplicationHome(),
/// );
/// ```
///
/// ## Update pubspec.yaml
///
/// Please make sure to update your pubspec.yaml to include the following
/// packages:
///
/// ```yaml
/// dependencies:
///   # Internationalization support.
///   flutter_localizations:
///     sdk: flutter
///   intl: any # Use the pinned version from flutter_localizations
///
///   # Rest of dependencies
/// ```
///
/// ## iOS Applications
///
/// iOS applications define key application metadata, including supported
/// locales, in an Info.plist file that is built into the application bundle.
/// To configure the locales supported by your app, you’ll need to edit this
/// file.
///
/// First, open your project’s ios/Runner.xcworkspace Xcode workspace file.
/// Then, in the Project Navigator, open the Info.plist file under the Runner
/// project’s Runner folder.
///
/// Next, select the Information Property List item, select Add Item from the
/// Editor menu, then select Localizations from the pop-up menu.
///
/// Select and expand the newly-created Localizations item then, for each
/// locale your application supports, add a new item and select the locale
/// you wish to add from the pop-up menu in the Value field. This list should
/// be consistent with the languages listed in the AppLocalizations.supportedLocales
/// property.
abstract class AppLocalizations {
  AppLocalizations(String locale) : localeName = intl.Intl.canonicalizedLocale(locale.toString());

  final String localeName;

  static AppLocalizations? of(BuildContext context) {
    return Localizations.of<AppLocalizations>(context, AppLocalizations);
  }

  static const LocalizationsDelegate<AppLocalizations> delegate = _AppLocalizationsDelegate();

  /// A list of this localizations delegate along with the default localizations
  /// delegates.
  ///
  /// Returns a list of localizations delegates containing this delegate along with
  /// GlobalMaterialLocalizations.delegate, GlobalCupertinoLocalizations.delegate,
  /// and GlobalWidgetsLocalizations.delegate.
  ///
  /// Additional delegates can be added by appending to this list in
  /// MaterialApp. This list does not have to be used at all if a custom list
  /// of delegates is preferred or required.
  static const List<LocalizationsDelegate<dynamic>> localizationsDelegates = <LocalizationsDelegate<dynamic>>[
    delegate,
    GlobalMaterialLocalizations.delegate,
    GlobalCupertinoLocalizations.delegate,
    GlobalWidgetsLocalizations.delegate,
  ];

  /// A list of this localizations delegate's supported locales.
  static const List<Locale> supportedLocales = <Locale>[
    Locale('de'),
    Locale('en'),
    Locale('fa')
  ];

  /// No description provided for @persiaMarkt.
  ///
  /// In en, this message translates to:
  /// **'PersiaMarkt'**
  String get persiaMarkt;

  /// No description provided for @home.
  ///
  /// In en, this message translates to:
  /// **'Home'**
  String get home;

  /// No description provided for @map.
  ///
  /// In en, this message translates to:
  /// **'Map'**
  String get map;

  /// No description provided for @favorites.
  ///
  /// In en, this message translates to:
  /// **'Favorites'**
  String get favorites;

  /// No description provided for @profile.
  ///
  /// In en, this message translates to:
  /// **'Profile'**
  String get profile;

  /// No description provided for @searchHint.
  ///
  /// In en, this message translates to:
  /// **'Search for bread, milk, stores...'**
  String get searchHint;

  /// No description provided for @yourLocation.
  ///
  /// In en, this message translates to:
  /// **'Your Location'**
  String get yourLocation;

  /// No description provided for @gettingLocation.
  ///
  /// In en, this message translates to:
  /// **'Getting location...'**
  String get gettingLocation;

  /// No description provided for @locationUnknown.
  ///
  /// In en, this message translates to:
  /// **'Location unknown'**
  String get locationUnknown;

  /// No description provided for @specialOffers.
  ///
  /// In en, this message translates to:
  /// **'Special Offers'**
  String get specialOffers;

  /// No description provided for @affordableProducts.
  ///
  /// In en, this message translates to:
  /// **'Affordable Products'**
  String get affordableProducts;

  /// No description provided for @stores.
  ///
  /// In en, this message translates to:
  /// **'Stores'**
  String get stores;

  /// No description provided for @myProfile.
  ///
  /// In en, this message translates to:
  /// **'My Profile'**
  String get myProfile;

  /// No description provided for @logout.
  ///
  /// In en, this message translates to:
  /// **'Logout'**
  String get logout;

  /// No description provided for @logoutFromAccount.
  ///
  /// In en, this message translates to:
  /// **'Logout from account'**
  String get logoutFromAccount;

  /// No description provided for @logoutConfirmation.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to log out?'**
  String get logoutConfirmation;

  /// No description provided for @cancel.
  ///
  /// In en, this message translates to:
  /// **'Cancel'**
  String get cancel;

  /// No description provided for @loginToSeeProfile.
  ///
  /// In en, this message translates to:
  /// **'Please log in to view your profile.'**
  String get loginToSeeProfile;

  /// No description provided for @guestUser.
  ///
  /// In en, this message translates to:
  /// **'Guest User'**
  String get guestUser;

  /// No description provided for @unknownEmail.
  ///
  /// In en, this message translates to:
  /// **'Unknown Email'**
  String get unknownEmail;

  /// No description provided for @accountSettings.
  ///
  /// In en, this message translates to:
  /// **'Account Settings'**
  String get accountSettings;

  /// No description provided for @orderHistory.
  ///
  /// In en, this message translates to:
  /// **'Order History'**
  String get orderHistory;

  /// No description provided for @changeLanguage.
  ///
  /// In en, this message translates to:
  /// **'Change Language'**
  String get changeLanguage;

  /// No description provided for @selectLanguage.
  ///
  /// In en, this message translates to:
  /// **'Select Language'**
  String get selectLanguage;

  /// No description provided for @persian.
  ///
  /// In en, this message translates to:
  /// **'Persian'**
  String get persian;

  /// No description provided for @english.
  ///
  /// In en, this message translates to:
  /// **'English'**
  String get english;

  /// No description provided for @german.
  ///
  /// In en, this message translates to:
  /// **'German'**
  String get german;

  /// No description provided for @categories.
  ///
  /// In en, this message translates to:
  /// **'Categories'**
  String get categories;

  /// No description provided for @viewAll.
  ///
  /// In en, this message translates to:
  /// **'View All'**
  String get viewAll;

  /// No description provided for @allProducts.
  ///
  /// In en, this message translates to:
  /// **'All Products'**
  String get allProducts;

  /// No description provided for @availableStores.
  ///
  /// In en, this message translates to:
  /// **'Available Stores'**
  String get availableStores;

  /// No description provided for @noProductsInCategory.
  ///
  /// In en, this message translates to:
  /// **'No products found in this category.'**
  String get noProductsInCategory;

  /// No description provided for @viewStore.
  ///
  /// In en, this message translates to:
  /// **'View Store'**
  String get viewStore;

  /// No description provided for @noDataAvailable.
  ///
  /// In en, this message translates to:
  /// **'Unfortunately, there are no stores or products to display at the moment.'**
  String get noDataAvailable;

  /// No description provided for @connectingToServer.
  ///
  /// In en, this message translates to:
  /// **'Connecting to server...'**
  String get connectingToServer;

  /// No description provided for @initialLoadingMessage.
  ///
  /// In en, this message translates to:
  /// **'Initial loading may take a moment. Please be patient.'**
  String get initialLoadingMessage;

  /// No description provided for @locationError.
  ///
  /// In en, this message translates to:
  /// **'Error converting location'**
  String get locationError;

  /// No description provided for @km.
  ///
  /// In en, this message translates to:
  /// **'km'**
  String get km;

  /// No description provided for @myLocation.
  ///
  /// In en, this message translates to:
  /// **'My Location'**
  String get myLocation;

  /// No description provided for @yourCartIsEmpty.
  ///
  /// In en, this message translates to:
  /// **'Your shopping cart is empty'**
  String get yourCartIsEmpty;

  /// No description provided for @yourShoppingCart.
  ///
  /// In en, this message translates to:
  /// **'Your Shopping Cart'**
  String get yourShoppingCart;

  /// No description provided for @storeRating.
  ///
  /// In en, this message translates to:
  /// **'Store Rating'**
  String get storeRating;

  /// No description provided for @loginToYourAccount.
  ///
  /// In en, this message translates to:
  /// **'Login to your Account'**
  String get loginToYourAccount;

  /// No description provided for @gladToSeeYouAgain.
  ///
  /// In en, this message translates to:
  /// **'Glad to see you again!'**
  String get gladToSeeYouAgain;

  /// No description provided for @email.
  ///
  /// In en, this message translates to:
  /// **'Email'**
  String get email;

  /// No description provided for @enterYourEmail.
  ///
  /// In en, this message translates to:
  /// **'Please enter your email'**
  String get enterYourEmail;

  /// No description provided for @invalidEmail.
  ///
  /// In en, this message translates to:
  /// **'Invalid email format'**
  String get invalidEmail;

  /// No description provided for @password.
  ///
  /// In en, this message translates to:
  /// **'Password'**
  String get password;

  /// No description provided for @enterYourPassword.
  ///
  /// In en, this message translates to:
  /// **'Please enter your password'**
  String get enterYourPassword;

  /// No description provided for @passwordTooShort.
  ///
  /// In en, this message translates to:
  /// **'At least 6 characters'**
  String get passwordTooShort;

  /// No description provided for @login.
  ///
  /// In en, this message translates to:
  /// **'Login'**
  String get login;

  /// No description provided for @noAccount.
  ///
  /// In en, this message translates to:
  /// **'No account? Sign up'**
  String get noAccount;

  /// No description provided for @sellerLogin.
  ///
  /// In en, this message translates to:
  /// **'Seller Login'**
  String get sellerLogin;

  /// No description provided for @sellerPanel.
  ///
  /// In en, this message translates to:
  /// **'Seller Panel'**
  String get sellerPanel;

  /// No description provided for @language.
  ///
  /// In en, this message translates to:
  /// **'Language'**
  String get language;
}

class _AppLocalizationsDelegate extends LocalizationsDelegate<AppLocalizations> {
  const _AppLocalizationsDelegate();

  @override
  Future<AppLocalizations> load(Locale locale) {
    return SynchronousFuture<AppLocalizations>(lookupAppLocalizations(locale));
  }

  @override
  bool isSupported(Locale locale) => <String>['de', 'en', 'fa'].contains(locale.languageCode);

  @override
  bool shouldReload(_AppLocalizationsDelegate old) => false;
}

AppLocalizations lookupAppLocalizations(Locale locale) {


  // Lookup logic when only language code is specified.
  switch (locale.languageCode) {
    case 'de': return AppLocalizationsDe();
    case 'en': return AppLocalizationsEn();
    case 'fa': return AppLocalizationsFa();
  }

  throw FlutterError(
    'AppLocalizations.delegate failed to load unsupported locale "$locale". This is likely '
    'an issue with the localizations generation tool. Please file an issue '
    'on GitHub with a reproducible sample app and the gen-l10n configuration '
    'that was used.'
  );
}


====================
فایل: app_localizations_de.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\l10n\app_localizations_de.dart
====================

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for German (`de`).
class AppLocalizationsDe extends AppLocalizations {
  AppLocalizationsDe([String locale = 'de']) : super(locale);

  @override
  String get persiaMarkt => 'PersiaMarkt';

  @override
  String get home => 'Startseite';

  @override
  String get map => 'Karte';

  @override
  String get favorites => 'Favoriten';

  @override
  String get profile => 'Profil';

  @override
  String get searchHint => 'Suche nach Brot, Milch, Geschäften...';

  @override
  String get yourLocation => 'Ihr Standort';

  @override
  String get gettingLocation => 'Standort wird abgerufen...';

  @override
  String get locationUnknown => 'Standort unbekannt';

  @override
  String get specialOffers => 'Sonderangebote';

  @override
  String get affordableProducts => 'Günstige Produkte';

  @override
  String get stores => 'Geschäfte';

  @override
  String get myProfile => 'Mein Profil';

  @override
  String get logout => 'Abmelden';

  @override
  String get logoutFromAccount => 'Abmelden';

  @override
  String get logoutConfirmation => 'Möchten Sie sich wirklich abmelden?';

  @override
  String get cancel => 'Abbrechen';

  @override
  String get loginToSeeProfile => 'Bitte melden Sie sich an, um Ihr Profil anzuzeigen.';

  @override
  String get guestUser => 'Gastnutzer';

  @override
  String get unknownEmail => 'Unbekannte E-Mail';

  @override
  String get accountSettings => 'Kontoeinstellungen';

  @override
  String get orderHistory => 'Bestellverlauf';

  @override
  String get changeLanguage => 'Sprache ändern / تغییر زبان';

  @override
  String get selectLanguage => 'Sprache auswählen / انتخاب زبان';

  @override
  String get persian => 'فارسی';

  @override
  String get english => 'English';

  @override
  String get german => 'Deutsch';

  @override
  String get categories => 'Kategorien';

  @override
  String get viewAll => 'Alle ansehen';

  @override
  String get allProducts => 'Alle Produkte';

  @override
  String get availableStores => 'Verfügbare Shops';

  @override
  String get noProductsInCategory => 'Keine Produkte in dieser Kategorie gefunden.';

  @override
  String get viewStore => 'Shop ansehen';

  @override
  String get noDataAvailable => 'Leider gibt es derzeit keine Geschäfte oder Produkte zum Anzeigen.';

  @override
  String get connectingToServer => 'Verbindung zum Server wird hergestellt...';

  @override
  String get initialLoadingMessage => 'Das erstmalige Laden kann einen Moment dauern. Bitte haben Sie Geduld.';

  @override
  String get locationError => 'Fehler bei der Standortkonvertierung';

  @override
  String get km => 'km';

  @override
  String get myLocation => 'Mein Standort';

  @override
  String get yourCartIsEmpty => 'Ihr Warenkorb ist leer';

  @override
  String get yourShoppingCart => 'Ihr Warenkorb';

  @override
  String get storeRating => 'Shop-Bewertung';

  @override
  String get loginToYourAccount => 'Anmelden bei Ihrem Konto';

  @override
  String get gladToSeeYouAgain => 'Schön, Sie wiederzusehen!';

  @override
  String get email => 'E-Mail';

  @override
  String get enterYourEmail => 'Bitte geben Sie Ihre E-Mail ein';

  @override
  String get invalidEmail => 'Ungültiges E-Mail-Format';

  @override
  String get password => 'Passwort';

  @override
  String get enterYourPassword => 'Bitte geben Sie Ihr Passwort ein';

  @override
  String get passwordTooShort => 'Mindestens 6 Zeichen';

  @override
  String get login => 'Anmelden';

  @override
  String get noAccount => 'Kein Konto? Registrieren';

  @override
  String get sellerLogin => 'Verkäufer-Login';

  @override
  String get sellerPanel => 'Verkäufer-Panel';

  @override
  String get language => 'Sprache';
}


====================
فایل: app_localizations_en.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\l10n\app_localizations_en.dart
====================

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for English (`en`).
class AppLocalizationsEn extends AppLocalizations {
  AppLocalizationsEn([String locale = 'en']) : super(locale);

  @override
  String get persiaMarkt => 'PersiaMarkt';

  @override
  String get home => 'Home';

  @override
  String get map => 'Map';

  @override
  String get favorites => 'Favorites';

  @override
  String get profile => 'Profile';

  @override
  String get searchHint => 'Search for bread, milk, stores...';

  @override
  String get yourLocation => 'Your Location';

  @override
  String get gettingLocation => 'Getting location...';

  @override
  String get locationUnknown => 'Location unknown';

  @override
  String get specialOffers => 'Special Offers';

  @override
  String get affordableProducts => 'Affordable Products';

  @override
  String get stores => 'Stores';

  @override
  String get myProfile => 'My Profile';

  @override
  String get logout => 'Logout';

  @override
  String get logoutFromAccount => 'Logout from account';

  @override
  String get logoutConfirmation => 'Are you sure you want to log out?';

  @override
  String get cancel => 'Cancel';

  @override
  String get loginToSeeProfile => 'Please log in to view your profile.';

  @override
  String get guestUser => 'Guest User';

  @override
  String get unknownEmail => 'Unknown Email';

  @override
  String get accountSettings => 'Account Settings';

  @override
  String get orderHistory => 'Order History';

  @override
  String get changeLanguage => 'Change Language';

  @override
  String get selectLanguage => 'Select Language';

  @override
  String get persian => 'Persian';

  @override
  String get english => 'English';

  @override
  String get german => 'German';

  @override
  String get categories => 'Categories';

  @override
  String get viewAll => 'View All';

  @override
  String get allProducts => 'All Products';

  @override
  String get availableStores => 'Available Stores';

  @override
  String get noProductsInCategory => 'No products found in this category.';

  @override
  String get viewStore => 'View Store';

  @override
  String get noDataAvailable => 'Unfortunately, there are no stores or products to display at the moment.';

  @override
  String get connectingToServer => 'Connecting to server...';

  @override
  String get initialLoadingMessage => 'Initial loading may take a moment. Please be patient.';

  @override
  String get locationError => 'Error converting location';

  @override
  String get km => 'km';

  @override
  String get myLocation => 'My Location';

  @override
  String get yourCartIsEmpty => 'Your shopping cart is empty';

  @override
  String get yourShoppingCart => 'Your Shopping Cart';

  @override
  String get storeRating => 'Store Rating';

  @override
  String get loginToYourAccount => 'Login to your Account';

  @override
  String get gladToSeeYouAgain => 'Glad to see you again!';

  @override
  String get email => 'Email';

  @override
  String get enterYourEmail => 'Please enter your email';

  @override
  String get invalidEmail => 'Invalid email format';

  @override
  String get password => 'Password';

  @override
  String get enterYourPassword => 'Please enter your password';

  @override
  String get passwordTooShort => 'At least 6 characters';

  @override
  String get login => 'Login';

  @override
  String get noAccount => 'No account? Sign up';

  @override
  String get sellerLogin => 'Seller Login';

  @override
  String get sellerPanel => 'Seller Panel';

  @override
  String get language => 'Language';
}


====================
فایل: app_localizations_fa.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\lib\l10n\app_localizations_fa.dart
====================

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for Persian (`fa`).
class AppLocalizationsFa extends AppLocalizations {
  AppLocalizationsFa([String locale = 'fa']) : super(locale);

  @override
  String get persiaMarkt => 'پرشیا مارکت';

  @override
  String get home => 'خانه';

  @override
  String get map => 'نقشه';

  @override
  String get favorites => 'موردعلاقه‌ها';

  @override
  String get profile => 'پروفایل';

  @override
  String get searchHint => 'جستجوی نان، شیر، فروشگاه...';

  @override
  String get yourLocation => 'موقعیت شما';

  @override
  String get gettingLocation => 'در حال دریافت موقعیت...';

  @override
  String get locationUnknown => 'موقعیت نامعلوم';

  @override
  String get specialOffers => 'پیشنهادهای ویژه';

  @override
  String get affordableProducts => 'محصولات مقرون به صرفه';

  @override
  String get stores => 'فروشگاه‌ها';

  @override
  String get myProfile => 'پروفایل من';

  @override
  String get logout => 'خروج';

  @override
  String get logoutFromAccount => 'خروج از حساب';

  @override
  String get logoutConfirmation => 'آیا برای خروج مطمئن هستید؟';

  @override
  String get cancel => 'انصراف';

  @override
  String get loginToSeeProfile => 'برای مشاهده پروفایل لطفاً وارد شوید.';

  @override
  String get guestUser => 'کاربر مهمان';

  @override
  String get unknownEmail => 'ایمیل نامشخص';

  @override
  String get accountSettings => 'تنظیمات حساب';

  @override
  String get orderHistory => 'تاریخچه سفارشات';

  @override
  String get changeLanguage => 'تغییر زبان';

  @override
  String get selectLanguage => 'انتخاب زبان';

  @override
  String get persian => 'فارسی';

  @override
  String get english => 'English';

  @override
  String get german => 'Deutsch';

  @override
  String get categories => 'دسته بندی ها';

  @override
  String get viewAll => 'مشاهده همه';

  @override
  String get allProducts => 'همه محصولات';

  @override
  String get availableStores => 'فروشگاه های موجود';

  @override
  String get noProductsInCategory => 'محصولی در این دسته‌بندی یافت نشد.';

  @override
  String get viewStore => 'مشاهده فروشگاه';

  @override
  String get noDataAvailable => 'متاسفانه در حال حاضر فروشگاه یا محصولی برای نمایش وجود ندارد.';

  @override
  String get connectingToServer => 'در حال اتصال به سرور...';

  @override
  String get initialLoadingMessage => 'بارگذاری اولیه ممکن است کمی طول بکشد. لطفاً صبور باشید.';

  @override
  String get locationError => 'خطا در تبدیل موقعیت';

  @override
  String get km => 'کیلومتر';

  @override
  String get myLocation => 'موقعیت من';

  @override
  String get yourCartIsEmpty => 'سبد خرید شما خالی است';

  @override
  String get yourShoppingCart => 'سبد خرید شما';

  @override
  String get storeRating => 'امتیاز فروشگاه';

  @override
  String get loginToYourAccount => 'ورود به حساب کاربری';

  @override
  String get gladToSeeYouAgain => 'خوشحالیم که دوباره شما را می‌بینیم!';

  @override
  String get email => 'ایمیل';

  @override
  String get enterYourEmail => 'ایمیل را وارد کنید';

  @override
  String get invalidEmail => 'ایمیل نامعتبر است';

  @override
  String get password => 'رمز عبور';

  @override
  String get enterYourPassword => 'رمز عبور را وارد کنید';

  @override
  String get passwordTooShort => 'حداقل ۶ کاراکتر';

  @override
  String get login => 'ورود';

  @override
  String get noAccount => 'حساب ندارید؟ ثبت‌نام';

  @override
  String get sellerLogin => 'ورود فروشنده';

  @override
  String get sellerPanel => 'پنل فروشندگان';

  @override
  String get language => 'زبان';
}


====================
فایل: web_plugin_registrant.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\persiamarkt_new\.dart_tool\dartpad\web_plugin_registrant.dart
====================

// Flutter web plugin registrant file.
//
// Generated file. Do not edit.
//

// ignore_for_file: type=lint

void registerPlugins() {}


====================
فایل: main.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\persiamarkt_new\lib\main.dart
====================

import 'package:flutter/material.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  // This widget is the root of your application.
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Flutter Demo',
      theme: ThemeData(
        // This is the theme of your application.
        //
        // TRY THIS: Try running your application with "flutter run". You'll see
        // the application has a purple toolbar. Then, without quitting the app,
        // try changing the seedColor in the colorScheme below to Colors.green
        // and then invoke "hot reload" (save your changes or press the "hot
        // reload" button in a Flutter-supported IDE, or press "r" if you used
        // the command line to start the app).
        //
        // Notice that the counter didn't reset back to zero; the application
        // state is not lost during the reload. To reset the state, use hot
        // restart instead.
        //
        // This works for code too, not just values: Most code changes can be
        // tested with just a hot reload.
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
      ),
      home: const MyHomePage(title: 'Flutter Demo Home Page'),
    );
  }
}

class MyHomePage extends StatefulWidget {
  const MyHomePage({super.key, required this.title});

  // This widget is the home page of your application. It is stateful, meaning
  // that it has a State object (defined below) that contains fields that affect
  // how it looks.

  // This class is the configuration for the state. It holds the values (in this
  // case the title) provided by the parent (in this case the App widget) and
  // used by the build method of the State. Fields in a Widget subclass are
  // always marked "final".

  final String title;

  @override
  State<MyHomePage> createState() => _MyHomePageState();
}

class _MyHomePageState extends State<MyHomePage> {
  int _counter = 0;

  void _incrementCounter() {
    setState(() {
      // This call to setState tells the Flutter framework that something has
      // changed in this State, which causes it to rerun the build method below
      // so that the display can reflect the updated values. If we changed
      // _counter without calling setState(), then the build method would not be
      // called again, and so nothing would appear to happen.
      _counter++;
    });
  }

  @override
  Widget build(BuildContext context) {
    // This method is rerun every time setState is called, for instance as done
    // by the _incrementCounter method above.
    //
    // The Flutter framework has been optimized to make rerunning build methods
    // fast, so that you can just rebuild anything that needs updating rather
    // than having to individually change instances of widgets.
    return Scaffold(
      appBar: AppBar(
        // TRY THIS: Try changing the color here to a specific color (to
        // Colors.amber, perhaps?) and trigger a hot reload to see the AppBar
        // change color while the other colors stay the same.
        backgroundColor: Theme.of(context).colorScheme.inversePrimary,
        // Here we take the value from the MyHomePage object that was created by
        // the App.build method, and use it to set our appbar title.
        title: Text(widget.title),
      ),
      body: Center(
        // Center is a layout widget. It takes a single child and positions it
        // in the middle of the parent.
        child: Column(
          // Column is also a layout widget. It takes a list of children and
          // arranges them vertically. By default, it sizes itself to fit its
          // children horizontally, and tries to be as tall as its parent.
          //
          // Column has various properties to control how it sizes itself and
          // how it positions its children. Here we use mainAxisAlignment to
          // center the children vertically; the main axis here is the vertical
          // axis because Columns are vertical (the cross axis would be
          // horizontal).
          //
          // TRY THIS: Invoke "debug painting" (choose the "Toggle Debug Paint"
          // action in the IDE, or press "p" in the console), to see the
          // wireframe for each widget.
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            const Text('You have pushed the button this many times:'),
            Text(
              '$_counter',
              style: Theme.of(context).textTheme.headlineMedium,
            ),
          ],
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _incrementCounter,
        tooltip: 'Increment',
        child: const Icon(Icons.add),
      ), // This trailing comma makes auto-formatting nicer for build methods.
    );
  }
}


====================
فایل: widget_test.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\persiamarkt_new\test\widget_test.dart
====================

// This is a basic Flutter widget test.
//
// To perform an interaction with a widget in your test, use the WidgetTester
// utility in the flutter_test package. For example, you can send tap and scroll
// gestures. You can also use WidgetTester to find child widgets in the widget
// tree, read text, and verify that the values of widget properties are correct.

import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';

import 'package:persiamarkt_new/main.dart';

void main() {
  testWidgets('Counter increments smoke test', (WidgetTester tester) async {
    // Build our app and trigger a frame.
    await tester.pumpWidget(const MyApp());

    // Verify that our counter starts at 0.
    expect(find.text('0'), findsOneWidget);
    expect(find.text('1'), findsNothing);

    // Tap the '+' icon and trigger a frame.
    await tester.tap(find.byIcon(Icons.add));
    await tester.pump();

    // Verify that our counter has incremented.
    expect(find.text('0'), findsNothing);
    expect(find.text('1'), findsOneWidget);
  });
}


====================
فایل: market_data_bloc_test.dart
مسیر: D:\PersiaMarkt 3\persiamarkt\test\features\home\presentation\bloc\market_data_bloc_test.dart
====================

// test/features/home/presentation/bloc/market_data_bloc_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:mocktail/mocktail.dart';
import 'package:fpdart/fpdart.dart';
import 'package:persia_markt/core/error/failures.dart';
import 'package:persia_markt/core/models/market_data.dart';
import 'package:persia_markt/features/home/domain/repositories/market_repository.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_bloc.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_event.dart';
import 'package:persia_markt/features/home/presentation/bloc/market_data_state.dart';

// ۱. یک کلاس Mock (شبیه‌سازی شده) از Repository می‌سازیم
// این به ما اجازه می‌دهد رفتار Repository را در تست کنترل کنیم
class MockMarketRepository extends Mock implements MarketRepository {}

void main() {
  // ۲. متغیرهای لازم برای تست را تعریف می‌کنیم
  late MarketDataBloc marketDataBloc;
  late MockMarketRepository mockMarketRepository;

  // این تابع قبل از اجرای هر تست فراخوانی می‌شود
  setUp(() {
    mockMarketRepository = MockMarketRepository();
    marketDataBloc = MarketDataBloc(marketRepository: mockMarketRepository);
  });

  // این تابع بعد از اجرای هر تست فراخوانی می‌شود تا منابع آزاد شوند
  tearDown(() {
    marketDataBloc.close();
  });

  // یک نمونه داده برای استفاده در تست موفقیت‌آمیز
  final tMarketData = const MarketData(stores: [], categories: [], products: []);

  test('حالت اولیه باید MarketDataInitial باشد', () {
    expect(marketDataBloc.state, isA<MarketDataInitial>());
  });

  group('FetchMarketDataEvent', () {
    // سناریوی تست برای زمانی که داده‌ها با موفقیت دریافت می‌شوند
    blocTest<MarketDataBloc, MarketDataState>(
      'باید حالت‌های [Loading, Loaded] را منتشر کند وقتی داده موفقیت‌آمیز است',
      build: () {
        // ۳. رفتار Mock را تعریف می‌کنیم: اگر getMarketData فراخوانی شد، یک نتیجه موفق برگردان
        when(() => mockMarketRepository.getMarketData())
            .thenAnswer((_) async => Right(tMarketData));
        return marketDataBloc;
      },
      act: (bloc) => bloc.add(FetchMarketDataEvent()), // ۴. رویداد (Event) را به BLoC ارسال می‌کنیم
      expect: () => [ // ۵. انتظار داریم که BLoC این حالت‌ها را به ترتیب منتشر کند
        isA<MarketDataLoading>(),
        isA<MarketDataLoaded>(),
      ],
      verify: (_) {
        // ۶. اطمینان حاصل می‌کنیم که متد getMarketData دقیقاً یک بار فراخوانی شده است
        verify(() => mockMarketRepository.getMarketData()).called(1);
      },
    );

    // سناریوی تست برای زمانی که خطا رخ می‌دهد
    blocTest<MarketDataBloc, MarketDataState>(
      'باید حالت‌های [Loading, Error] را منتشر کند وقتی خطا رخ می‌دهد',
      build: () {
        // رفتار Mock را برای حالت خطا تعریف می‌کنیم
        when(() => mockMarketRepository.getMarketData())
            .thenAnswer((_) async => const Left(ServerFailure('API Failure')));
        return marketDataBloc;
      },
      act: (bloc) => bloc.add(FetchMarketDataEvent()),
      expect: () => [
        isA<MarketDataLoading>(),
        isA<MarketDataError>(),
      ],
      verify: (_) {
        verify(() => mockMarketRepository.getMarketData()).called(1);
      },
    );
  });
}